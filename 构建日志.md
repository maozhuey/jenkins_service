Started by user admin

Obtained Jenkinsfile.aliyun from git git@github.com:maozhuey/tbk.git
[Pipeline] Start of Pipeline
[Pipeline] node
Running on Jenkins
 in /var/jenkins_home/workspace/tbk-pipeline
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Declarative: Checkout SCM)
[Pipeline] checkout
Selected Git installation does not exist. Using Default
The recommended git tool is: NONE
Warning: CredentialId "git-credentials" could not be found.
 > git rev-parse --resolve-git-dir /var/jenkins_home/workspace/tbk-pipeline/.git # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url git@github.com:maozhuey/tbk.git # timeout=10
Fetching upstream changes from git@github.com:maozhuey/tbk.git
 > git --version # timeout=10
 > git --version # 'git version 2.39.5'
 > git fetch --tags --force --progress -- git@github.com:maozhuey/tbk.git +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git rev-parse refs/remotes/origin/main^{commit} # timeout=10
Checking out Revision 2de4d504e37d0def2e2ebe784e512415167e030a (refs/remotes/origin/main)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 2de4d504e37d0def2e2ebe784e512415167e030a # timeout=10
Commit message: "‰øÆÂ§çÁîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆÔºöÁßªÈô§versionÂ≠óÊÆµÔºåÊõ¥Êñ∞ÁΩëÁªúÈÖçÁΩÆ"
 > git rev-list --no-walk 2de4d504e37d0def2e2ebe784e512415167e030a # timeout=10
[Pipeline] }
[Pipeline] // stage
[Pipeline] withEnv
[Pipeline] {
[Pipeline] withEnv
[Pipeline] {
[Pipeline] stage
[Pipeline] { (Checkout)
[Pipeline] echo
üîÑ Checking out code from repository...
[Pipeline] echo
üåø Target Branch: main (Áîü‰∫ßÁéØÂ¢É)
[Pipeline] echo
üìù Branch Info: main (Áîü‰∫ßÁéØÂ¢É)
[Pipeline] checkout
Selected Git installation does not exist. Using Default
The recommended git tool is: NONE
Warning: CredentialId "git-credentials" could not be found.
 > git rev-parse --resolve-git-dir /var/jenkins_home/workspace/tbk-pipeline/.git # timeout=10
Fetching changes from the remote Git repository
 > git config remote.origin.url git@github.com:maozhuey/tbk.git # timeout=10
Fetching upstream changes from git@github.com:maozhuey/tbk.git
 > git --version # timeout=10
 > git --version # 'git version 2.39.5'
 > git fetch --tags --force --progress -- git@github.com:maozhuey/tbk.git +refs/heads/*:refs/remotes/origin/* # timeout=10
 > git rev-parse refs/remotes/origin/main^{commit} # timeout=10
Checking out Revision 2de4d504e37d0def2e2ebe784e512415167e030a (refs/remotes/origin/main)
 > git config core.sparsecheckout # timeout=10
 > git checkout -f 2de4d504e37d0def2e2ebe784e512415167e030a # timeout=10
Commit message: "‰øÆÂ§çÁîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆÔºöÁßªÈô§versionÂ≠óÊÆµÔºåÊõ¥Êñ∞ÁΩëÁªúÈÖçÁΩÆ"
[Pipeline] script
[Pipeline] {
[Pipeline] sh
+ git rev-parse --short HEAD
[Pipeline] }
[Pipeline] // script
[Pipeline] echo
‚úÖ Code checkout completed
[Pipeline] echo
üìã Build Info: Build #93, Branch: main, Commit: 2de4d50
[Pipeline] echo
üéØ Production Deploy: true
[Pipeline] echo
üîí Auto Deploy Enabled: true
[Pipeline] echo
üìã Deploy Strategy: rolling
[Pipeline] echo
üåê Deploy Env: production
[Pipeline] script
[Pipeline] {
[Pipeline] echo
üõ°Ô∏è Branch Security Check:
[Pipeline] echo
   - Current Branch: main
[Pipeline] echo
   - Is Main Branch: true
[Pipeline] echo
   - Production Deploy Allowed: true
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Resolve Config by DEPLOY_ENV and PROJECT)
[Pipeline] echo
üß≠ Resolving env and compose files from configuration...
[Pipeline] script
[Pipeline] {
[Pipeline] readFile
[Pipeline] echo
üì¶ PROJECT: tbk
[Pipeline] echo
üåê DEPLOY_ENV: production
[Pipeline] echo
üìÑ ENV_FILE: .env.production
[Pipeline] echo
üóÇÔ∏è LOCAL COMPOSE: docker-compose.production.yml
[Pipeline] echo
üóÇÔ∏è REMOTE COMPOSE: aliyun-ecs-deploy.yml
[Pipeline] echo
üìç ECS_DEPLOY_PATH: /opt/apps/tbk
[Pipeline] echo
‚ù§Ô∏è HEALTH_CHECK_URL: http://60.205.0.185:8080/api/health
[Pipeline] }
[Pipeline] // script
[Pipeline] echo
‚úÖ Configuration resolved
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Environment Setup)
[Pipeline] echo
üîß Setting up build environment...
[Pipeline] sh
+ echo Node.js version:
Node.js version:
+ node --version
v18.20.8
+ echo NPM version:
NPM version:
+ npm --version
10.8.2
+ echo Docker version:
Docker version:
+ docker --version
Docker version 28.5.0, build 887030f
[Pipeline] echo
‚úÖ Environment setup completed
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Install Dependencies)
[Pipeline] echo
üì¶ Installing project dependencies...
[Pipeline] sh
+ npm ci --only=production
npm warn config only Use `--omit=dev` to omit dev dependencies from the install.

added 93 packages, and audited 94 packages in 2s

18 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
+ echo Dependencies installed successfully
Dependencies installed successfully
[Pipeline] echo
‚úÖ Dependencies installation completed
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Code Analysis)
[Pipeline] echo
üîç Running code analysis...
[Pipeline] sh
+ echo Running ESLint...
Running ESLint...
+ npx eslint . --ext .js,.jsx,.ts,.tsx --format compact

Oops! Something went wrong! :(

ESLint: 9.37.0

ESLint couldn't find an eslint.config.(js|mjs|cjs) file.

From ESLint v9.0.0, the default configuration file is now eslint.config.js.
If you are using a .eslintrc.* file, please follow the migration guide
to update your configuration file to the new format:

https://eslint.org/docs/latest/use/configure/migration-guide

If you still have problems after following the migration guide, please stop by
https://eslint.org/chat/help to chat with the team.

+ true
+ echo Code analysis completed
Code analysis completed
[Pipeline] echo
‚úÖ Code analysis completed
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Unit Tests)
[Pipeline] echo
üß™ Running unit tests...
[Pipeline] sh
+ echo Running Jest tests...
Running Jest tests...
+ npm test -- --coverage --watchAll=false

> peach-wiki-backend@1.0.0 test
> echo 'Tests completed - no tests configured' --coverage --watchAll=false

Tests completed - no tests configured --coverage --watchAll=false
+ echo Unit tests completed
Unit tests completed
[Pipeline] echo
‚úÖ Unit tests completed
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Build Docker Image)
[Pipeline] echo
üê≥ Building Docker image...
[Pipeline] script
[Pipeline] {
[Pipeline] echo
Preparing multi-arch build: crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:93-2de4d50 (+ latest)
[Pipeline] echo
Image will be built and pushed in next stage using buildx
[Pipeline] }
[Pipeline] // script
[Pipeline] echo
‚úÖ Docker image build completed
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Push to Aliyun ACR)
[Pipeline] echo
üì§ Pushing Docker image to Aliyun ACR...
[Pipeline] script
[Pipeline] {
[Pipeline] withEnv
[Pipeline] {
[Pipeline] withDockerRegistry
$ docker login -u aliyun7971892098 -p ******** https://crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com
WARNING! Using --password via the CLI is insecure. Use --password-stdin.

WARNING! Your credentials are stored unencrypted in '/var/jenkins_home/workspace/tbk-pipeline@tmp/ef45e161-fd8e-4506-b95c-854f251e0464/config.json'.
Configure a credential helper to remove this warning. See
https://docs.docker.com/go/credential-store/

Login Succeeded
[Pipeline] {
[Pipeline] sh
+ set -e
+ echo Building Docker image...
Building Docker image...
+ docker build --platform linux/amd64 -t crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:93-2de4d50 -t crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest .
#0 building with "default" instance using docker driver

#1 [internal] load build definition from Dockerfile
#1 transferring dockerfile: 875B done
#1 DONE 0.0s

#2 [internal] load metadata for docker.io/library/node:18-alpine
#2 DONE 0.4s

#3 [internal] load .dockerignore
#3 transferring context: 1.10kB done
#3 DONE 0.0s

#4 [internal] load build context
#4 DONE 0.0s

#5 [1/7] FROM docker.io/library/node:18-alpine@sha256:8d6421d663b4c28fd3ebc498332f249011d118945588d0a35cb9bc4b8ca09d9e
#5 resolve docker.io/library/node:18-alpine@sha256:8d6421d663b4c28fd3ebc498332f249011d118945588d0a35cb9bc4b8ca09d9e
#5 resolve docker.io/library/node:18-alpine@sha256:8d6421d663b4c28fd3ebc498332f249011d118945588d0a35cb9bc4b8ca09d9e 3.4s done
#5 DONE 3.4s

#4 [internal] load build context
#4 transferring context: 283.05kB 0.0s done
#4 DONE 0.0s

#6 [3/7] COPY package*.json ./
#6 CACHED

#7 [4/7] RUN npm ci && npm cache clean --force
#7 CACHED

#8 [6/7] RUN addgroup -g 1001 -S nodejs &&     adduser -S nodejs -u 1001
#8 CACHED

#9 [2/7] WORKDIR /app
#9 CACHED

#10 [5/7] COPY . .
#10 CACHED

#11 [7/7] RUN mkdir -p /app/logs &&     chown -R nodejs:nodejs /app
#11 CACHED

#12 exporting to image
#12 exporting layers done
#12 exporting manifest sha256:72a36d068d133144016afe420e66a497db0b981d48c1b7ed99e28d323a97d947 done
#12 exporting config sha256:89519919b037aa6632e79c3a3db2a75263276a89c115646cbfe6a9939ea2e964 done
#12 exporting attestation manifest sha256:aff8f270ee4492f94bfd6f91d55b98e34da3fc472bd98b61e19ff72192f6b0d8 done
#12 exporting manifest list sha256:5ead33a244904c542a2e327e53d2e2c02a3a61abdb1a30f02760367536fe79dc done
#12 naming to crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:93-2de4d50 done
#12 naming to crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest done
#12 DONE 0.1s
+ echo Pushing Docker images...
Pushing Docker images...
+ docker push crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:93-2de4d50
The push refers to repository [crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk]
acbdf6764093: Waiting
f18232174bc9: Waiting
6edce9b085ee: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
7c2bc64261a2: Waiting
7abb388f8098: Waiting
dd71dde834b5: Waiting
a433a3913df1: Waiting
1e5a4c89cee5: Waiting
573b4d5974a9: Waiting
a433a3913df1: Waiting
1e5a4c89cee5: Waiting
573b4d5974a9: Waiting
7abb388f8098: Waiting
dd71dde834b5: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
7c2bc64261a2: Waiting
acbdf6764093: Waiting
f18232174bc9: Waiting
6edce9b085ee: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
7c2bc64261a2: Waiting
acbdf6764093: Waiting
f18232174bc9: Waiting
6edce9b085ee: Waiting
a433a3913df1: Waiting
1e5a4c89cee5: Waiting
573b4d5974a9: Waiting
7abb388f8098: Waiting
dd71dde834b5: Waiting
f18232174bc9: Waiting
6edce9b085ee: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
7c2bc64261a2: Waiting
acbdf6764093: Waiting
dd71dde834b5: Waiting
a433a3913df1: Waiting
1e5a4c89cee5: Waiting
573b4d5974a9: Waiting
7abb388f8098: Waiting
1e5a4c89cee5: Waiting
573b4d5974a9: Waiting
7abb388f8098: Waiting
dd71dde834b5: Waiting
a433a3913df1: Waiting
25ff2da83641: Waiting
7c2bc64261a2: Waiting
acbdf6764093: Waiting
f18232174bc9: Waiting
6edce9b085ee: Waiting
d89bdee7dc35: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
7c2bc64261a2: Waiting
acbdf6764093: Waiting
f18232174bc9: Waiting
6edce9b085ee: Waiting
a433a3913df1: Waiting
1e5a4c89cee5: Waiting
573b4d5974a9: Waiting
7abb388f8098: Waiting
dd71dde834b5: Waiting
dd71dde834b5: Waiting
a433a3913df1: Waiting
1e5a4c89cee5: Waiting
573b4d5974a9: Waiting
7abb388f8098: Layer already exists
f18232174bc9: Waiting
6edce9b085ee: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
7c2bc64261a2: Waiting
acbdf6764093: Waiting
7c2bc64261a2: Layer already exists
acbdf6764093: Layer already exists
f18232174bc9: Layer already exists
6edce9b085ee: Layer already exists
d89bdee7dc35: Waiting
25ff2da83641: Layer already exists
573b4d5974a9: Waiting
dd71dde834b5: Layer already exists
a433a3913df1: Layer already exists
1e5a4c89cee5: Waiting
1e5a4c89cee5: Layer already exists
573b4d5974a9: Layer already exists
d89bdee7dc35: Pushed
93-2de4d50: digest: sha256:5ead33a244904c542a2e327e53d2e2c02a3a61abdb1a30f02760367536fe79dc size: 856
+ docker push crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest
The push refers to repository [crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk]
d89bdee7dc35: Waiting
25ff2da83641: Waiting
f18232174bc9: Waiting
acbdf6764093: Waiting
7abb388f8098: Waiting
6edce9b085ee: Waiting
a433a3913df1: Waiting
7c2bc64261a2: Waiting
dd71dde834b5: Waiting
573b4d5974a9: Waiting
1e5a4c89cee5: Waiting
1e5a4c89cee5: Waiting
7abb388f8098: Waiting
6edce9b085ee: Waiting
a433a3913df1: Waiting
7c2bc64261a2: Waiting
dd71dde834b5: Waiting
573b4d5974a9: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
f18232174bc9: Waiting
acbdf6764093: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
f18232174bc9: Waiting
acbdf6764093: Waiting
a433a3913df1: Waiting
7c2bc64261a2: Waiting
dd71dde834b5: Waiting
573b4d5974a9: Waiting
1e5a4c89cee5: Waiting
7abb388f8098: Waiting
6edce9b085ee: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
f18232174bc9: Waiting
acbdf6764093: Waiting
1e5a4c89cee5: Waiting
7abb388f8098: Waiting
6edce9b085ee: Waiting
a433a3913df1: Waiting
7c2bc64261a2: Waiting
dd71dde834b5: Waiting
573b4d5974a9: Waiting
f18232174bc9: Waiting
acbdf6764093: Layer already exists
d89bdee7dc35: Waiting
25ff2da83641: Waiting
dd71dde834b5: Waiting
573b4d5974a9: Waiting
1e5a4c89cee5: Waiting
7abb388f8098: Waiting
6edce9b085ee: Waiting
a433a3913df1: Waiting
7c2bc64261a2: Waiting
f18232174bc9: Waiting
d89bdee7dc35: Waiting
25ff2da83641: Waiting
dd71dde834b5: Waiting
573b4d5974a9: Layer already exists
1e5a4c89cee5: Layer already exists
7abb388f8098: Waiting
6edce9b085ee: Waiting
a433a3913df1: Waiting
7c2bc64261a2: Waiting
d89bdee7dc35: Already exists
25ff2da83641: Layer already exists
f18232174bc9: Layer already exists
7abb388f8098: Layer already exists
6edce9b085ee: Layer already exists
a433a3913df1: Layer already exists
7c2bc64261a2: Layer already exists
dd71dde834b5: Layer already exists
latest: digest: sha256:5ead33a244904c542a2e327e53d2e2c02a3a61abdb1a30f02760367536fe79dc size: 856
+ echo Docker images pushed successfully
Docker images pushed successfully
[Pipeline] }
[Pipeline] // withDockerRegistry
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // script
[Pipeline] echo
‚úÖ Docker image push completed
[Pipeline] echo
üéØ Images available at:
[Pipeline] echo
   - crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:93-2de4d50
[Pipeline] echo
   - crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Database Migration)
[Pipeline] echo
üóÑÔ∏è Running database migrations...
[Pipeline] sh
+ echo Checking database connection...
Checking database connection...
+ echo Running migrations...
Running migrations...
+ echo Database migration completed
Database migration completed
[Pipeline] echo
‚úÖ Database migration completed
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Deploy to Aliyun ECS)
[Pipeline] echo
üöÄ Deploying to Aliyun ECS...
[Pipeline] echo
üìã Deployment Configuration:
[Pipeline] echo
   - Strategy: rolling
[Pipeline] echo
   - Branch: main
[Pipeline] echo
   - Image: crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest
[Pipeline] script
[Pipeline] {
[Pipeline] sh
+ set -e
+ echo Ensuring remote deploy directory exists...
Ensuring remote deploy directory exists...
+ ssh -o StrictHostKeyChecking=no root@60.205.0.185 mkdir -p /opt/apps/tbk
+ echo Syncing compose and env files to remote...
Syncing compose and env files to remote...
+ [ -f aliyun-ecs-deploy.yml ]
+ scp -o StrictHostKeyChecking=no aliyun-ecs-deploy.yml root@60.205.0.185:/opt/apps/tbk/
+ [ -f .env.production ]
+ scp -o StrictHostKeyChecking=no .env.production root@60.205.0.185:/opt/apps/tbk/
[Pipeline] sh
+ set -e
+ echo Connecting to Aliyun ECS host...
Connecting to Aliyun ECS host...
+ pwd
+ pwd
+ pwd
+ pwd
+ pwd
+ pwd
+ ssh -o StrictHostKeyChecking=no root@60.205.0.185 
                              set -e
                              cd /opt/apps/tbk
                              echo 'Cleaning up existing containers and networks...'
                              docker network create tbk_app-network || true
                              ENV_ARG=''
                              if [ -f .env.production ]; then ENV_ARG='--env-file .env.production'; fi
                              DEPLOY_STRATEGY='rolling'
                              echo Using strategy: rolling
                              case rolling in
                                recreate)
                                  docker compose  -f aliyun-ecs-deploy.yml down --remove-orphans || true
                                  docker network prune -f || true
                                  echo 'Pulling latest image...'
                                  docker compose  -f aliyun-ecs-deploy.yml pull tbk-production
                                  echo 'Starting services with force recreate...'
                                  docker compose  -f aliyun-ecs-deploy.yml up -d --force-recreate tbk-production nginx-production
                                  ;;
                                docker-run)
                                  echo 'Using docker-run fallback strategy...'
                                  docker rm -f nginx-production tbk-production || true
                                  docker network create tbk-production-network || true
                                  echo 'Pulling latest image...'
                                  docker pull crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest
                                  DOCKER_RUN_ENV=''
                                  if [ -f .env.production ]; then DOCKER_RUN_ENV='--env-file .env.production'; fi
                                  echo 'Starting app container...'
                                  docker run -d --name tbk-production --restart unless-stopped                                     --network tbk-production-network                                     -v /var/jenkins_home/workspace/tbk-pipeline/logs:/app/logs -v /var/jenkins_home/workspace/tbk-pipeline/uploads:/app/uploads -v /var/jenkins_home/workspace/tbk-pipeline/ssl:/app/ssl:ro                                                                          crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest
                                  echo 'Connecting app to external MySQL network...'
                                  docker network connect tbk_app-network tbk-production || true
                                  echo 'Starting nginx container...'
                                  docker run -d --name nginx-production --restart unless-stopped                                     --network tbk-production-network                                     -p 8080:80 -p 8443:443                                     -v /var/jenkins_home/workspace/tbk-pipeline/nginx/production.conf:/etc/nginx/conf.d/default.conf:ro                                     -v /var/jenkins_home/workspace/tbk-pipeline/ssl:/etc/nginx/ssl:ro                                     -v /var/jenkins_home/workspace/tbk-pipeline/logs/nginx:/var/log/nginx                                     nginx:alpine
                                  ;;
                                *)
                                  docker compose  -f aliyun-ecs-deploy.yml down --remove-orphans || true
                                  docker network prune -f || true
                                  echo 'Pulling latest image...'
                                  docker compose  -f aliyun-ecs-deploy.yml pull tbk-production
                                  echo 'Starting services (rolling)...'
                                  docker compose  -f aliyun-ecs-deploy.yml up -d tbk-production nginx-production
                                  ;;
                              esac
                              echo 'Waiting for services to start...'
                              sleep 10
                              echo 'Checking service health...'
                              for i in 1 2 3; do
                                  if curl -fsSL http://localhost:8080/api/health; then
                                      echo 'Health check passed!'
                                      break
                                  else
                                      echo Health check attempt failed, retrying in 5 seconds...
                                      sleep 5
                                  fi
                              done
                              echo 'Deployment completed'
                            
Cleaning up existing containers and networks...
f90a70046afb40f86ef3a3cdcbe75b662cec6d83be3d41f7274d61dab5052648
Using strategy: rolling
time="2025-10-05T22:50:23+08:00" level=warning msg="/opt/apps/tbk/aliyun-ecs-deploy.yml: `version` is obsolete"
 Network tbk_tbk-production-network  Removing
 Network tbk_tbk-production-network  Resource is still in use
Deleted Networks:
tbk_app-network

Pulling latest image...
time="2025-10-05T22:50:23+08:00" level=warning msg="/opt/apps/tbk/aliyun-ecs-deploy.yml: `version` is obsolete"
 tbk-production Pulling 
 tbk-production Pulled 
Starting services (rolling)...
time="2025-10-05T22:50:24+08:00" level=warning msg="/opt/apps/tbk/aliyun-ecs-deploy.yml: `version` is obsolete"
 tbk-production Pulling 
 tbk-production Pulled 
Error response from daemon: network tbk_app-network not found
[Pipeline] echo
‚ùå Deployment failed: script returned exit code 1
[Pipeline] echo
üîÑ Initiating rollback...
[Pipeline] sh
+ echo Rolling back to previous version...
Rolling back to previous version...
+ echo Rollback completed
Rollback completed
[Pipeline] }
[Pipeline] // script
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Post-Deploy Tests)
Stage "Post-Deploy Tests" skipped due to earlier failure(s)
[Pipeline] getContext
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Build Only Summary)
Stage "Build Only Summary" skipped due to earlier failure(s)
[Pipeline] getContext
[Pipeline] }
[Pipeline] // stage
[Pipeline] stage
[Pipeline] { (Declarative: Post Actions)
[Pipeline] echo
üßπ Cleaning up workspace...
[Pipeline] sh
+ docker system prune -f --volumes
Deleted build cache objects:
vtx4yxosoxpxkqvca5zv997kh
n6fzim76lne3nv6ayjoelas7a
qjrlb9rhci4svufixfcc6j0eh

Total reclaimed space: 442.4kB
+ echo Cleanup completed
Cleanup completed
[Pipeline] echo
‚ùå Pipeline failed!
[Pipeline] echo
üìã Build Info: Build #93, Commit: 2de4d50
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // withEnv
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
ERROR: script returned exit code 1
Finished: FAILURE




## ÈóÆÈ¢òÂàÜÊûê‰∏é‰øÆÂ§çËÆ∞ÂΩï

- ÁóáÁä∂ÔºöÊúçÂä°ÂêØÂä®Èò∂ÊÆµÊä•Èîô `Error response from daemon: network tbk_app-network not found`ÔºåÂêåÊó∂Êó•ÂøóÂá∫Áé∞ Compose `version` Â≠óÊÆµÂ∑≤Â∫üÂºÉÁöÑË≠¶Âëä„ÄÇ
- Ê†πÂõ†ÔºöÈÉ®ÁΩ≤ËÑöÊú¨Âú® `recreate` Á≠ñÁï•‰∏≠ÊâßË°å‰∫Ü‰∏çÂä†Á≠õÈÄâÁöÑ `docker network prune -f`Ôºå‰ºöÊ∏ÖÁêÜÊâÄÊúâÊú™‰ΩøÁî®ÁΩëÁªúÔºåÂØºËá¥Â§ñÈÉ®ÁΩëÁªú `tbk_app-network` Ë¢´Âà†Èô§ÔºõÈöèÂêé `docker compose up` Êó†Ê≥ïÂä†ÂÖ•ËØ•ÁΩëÁªúËÄåÊä•Èîô„ÄÇÂè¶‰∏Ä‰∏™ËØ±Âõ†ÊòØÂéÜÂè≤‰∏äÊú™‰øÆË°•ÁöÑÊú¨Âú∞ `docker-compose.production.yml` ÊõæË¢´Êã∑Ë¥ùÂà∞Áîü‰∫ßÔºåËß¶ÂèëÊóßÁâà `version` Ë≠¶Âëä‰∏é‰∏ç‰∏ÄËá¥ÈÖçÁΩÆ„ÄÇ

Â∑≤ÂÆûÊñΩ‰øÆÂ§çÔºö
- Â∞Ü Jenkins ÈÉ®ÁΩ≤ËÑöÊú¨Êõ¥Êñ∞‰∏∫‚ÄúÂÆâÂÖ®Ê∏ÖÁêÜ‚ÄùÔºåÂè™Ê∏ÖÁêÜÈùûÂ§ñÈÉ®ÁΩëÁªúÔºö
  - ‰ΩøÁî® `docker network prune -f --filter "label!=external"`Ôºå‰øùÁïôÊâì‰∏ä `external=true` Ê†áÁ≠æÁöÑÂ§ñÈÉ®ÁΩëÁªú„ÄÇ
  - Âú®ÂêØÂä®ÂâçÊòæÂºèÂàõÂª∫Â§ñÈÉ®ÁΩëÁªúÂπ∂ÊâìÊ†áÁ≠æÔºö`docker network create tbk_app-network --subnet=172.21.0.0/16 --label external=true || true`„ÄÇ
- Áªü‰∏Ä Compose ÈÖçÁΩÆÔºå`aliyun-ecs-deploy.yml` ‰ΩøÁî® `tbk_app-network: external: true`ÔºåÂπ∂‰∏é `tbk-production-network` ÂØπÈΩêÔºõÊ∏ÖÈô§ÊóßÁâà `version` Â≠óÊÆµÔºàCompose v2 ‰∏çÂÜçÈúÄË¶ÅÔºâ„ÄÇ
- Ê†°È™åÁÆ°ÈÅì‰ΩøÁî®ÁöÑ Jenkinsfile ÊåáÂêëÂ∑≤‰øÆÂ§çÁöÑÁâàÊú¨ÔºåÈÅøÂÖçÁªßÁª≠‰ΩøÁî®ÊóßËÑöÊú¨„ÄÇ

È™åËØÅÊ≠•È™§‰∏éÁªìÊûúÔºö
- ËøêË°å `docker compose -f aliyun-ecs-deploy.yml config` Ê≠£Â∏∏ÔºåÊú™ÂÜçÂá∫Áé∞ `version` Â∫üÂºÉË≠¶Âëä„ÄÇ
- Âú®‰øÆÂ§çÂêéÁöÑÊµÅÊ∞¥Á∫øÊó•Âøó‰∏≠Ôºå`Using strategy: rolling` Ë∑ØÂæÑ‰∏çÂÜçÊâßË°å‰∏çÂÆâÂÖ®ÁöÑ `network prune`Ôºõ`recreate` Ë∑ØÂæÑ‰ªÖÊ∏ÖÁêÜÈùûÂ§ñÈÉ®ÁΩëÁªúÔºåÂπ∂Âú® `up` ÂâçÁ°Æ‰øù `tbk_app-network` Â≠òÂú®„ÄÇ
- ÈÄöËøáËÑöÊú¨ `verify-deployment-fix.sh` È™åËØÅÔºö
  - ËØ≠Ê≥ïÊ£ÄÊü•ÈÄöËøáÔºõ
  - `tbk_app-network` ‰∏é `tbk-production-network` ÂùáÂú®ÈÖçÁΩÆ‰∏≠Ôºõ
  - Êï∞ÊçÆÂ∫ì‰∏éÂÅ•Â∫∑Ê£ÄÊü•ÈÖçÁΩÆÂ≠òÂú®Ôºõ
  - Á´ØÂè£ÈááÁî® `expose`ÔºåÈÅøÂÖçÂÆø‰∏ªÁ´ØÂè£ÂÜ≤Á™ÅÔºõ
  - È¢ùÂ§ñÊ£ÄÊü•Â§ñÈÉ®ÁΩëÁªúÊ†áÁ≠æ‰∏é Jenkinsfile ‰∏≠ÁöÑÂÆâÂÖ® prune ËßÑÂàô„ÄÇ

ÂêéÁª≠Âª∫ËÆÆÔºö
- Á°ÆËÆ§ Jenkins ‰ªªÂä°‰ΩøÁî® `Jenkinsfile.aliyun` ÁöÑÊúÄÊñ∞ÁâàÊú¨ÔºàÊàñÁªü‰∏ÄÊîπ‰∏∫ËØ•Êñá‰ª∂Ôºâ„ÄÇ
- Â∞ÜÊóßÁöÑ `docker-compose.production.yml` ‰ªéÁîü‰∫ßÁõÆÂΩïÊ∏ÖÁêÜÔºåÈÅøÂÖçË¢´ËØØÁî®„ÄÇ
- Â∞ÜÁΩëÁªúÊ†áÁ≠æÁ≠ñÁï•Á∫≥ÂÖ•Ê†áÂáÜÊµÅÁ®ãÊñáÊ°£ÔºåÈÅøÂÖçÂêéÁª≠Ê∏ÖÁêÜËØØÂà†Â§ñÈÉ®ÁΩëÁªú„ÄÇ

### Á¨¨‰∫åÊ¨°ÊûÑÂª∫Â§±Ë¥• (2025-10-05)

#### ÂèëÁé∞ÁöÑÈóÆÈ¢ò
1. **ÈÖçÁΩÆÊñá‰ª∂Ë¢´Ë¶ÜÁõñ**ÔºöÁîü‰∫ßÁéØÂ¢ÉÁöÑ `aliyun-ecs-deploy.yml` ÂèàÂá∫Áé∞‰∫Ü `version: '3.8'` Ë≠¶Âëä
2. **ÁΩëÁªúÈîôËØØÈáçÁé∞**Ôºö`Error response from daemon: network tbk_app-network not found`
3. **Ê†πÊú¨ÂéüÂõ†**ÔºöJenkinsÈÉ®ÁΩ≤Êó∂‰ºö‰ªéÊú¨Âú∞ÁöÑ `docker-compose.production.yml` Â§çÂà∂Âà∞Áîü‰∫ßÁéØÂ¢ÉÂπ∂ÈáçÂëΩÂêç‰∏∫ `aliyun-ecs-deploy.yml`Ôºå‰ΩÜÊú¨Âú∞Êñá‰ª∂Ê≤°Êúâ‰øÆÂ§ç

#### ‰øÆÂ§çÊé™ÊñΩ
1. **‰øÆÂ§çÊú¨Âú∞ÈÖçÁΩÆÊñá‰ª∂**Ôºö
   - ÁßªÈô§Êú¨Âú∞ `docker-compose.production.yml` ‰∏≠ÁöÑ `version: '3.8'`
   - ‰ªéÁîü‰∫ßÁéØÂ¢ÉÂ§çÂà∂Ê≠£Á°ÆÁöÑÁΩëÁªúÈÖçÁΩÆÂà∞Êú¨Âú∞
   - Êèê‰∫§Âπ∂Êé®ÈÄÅÂà∞Git‰ªìÂ∫ì

2. **‰øÆÂ§çfluentdÈÖçÁΩÆ**Ôºö
   - ÂèëÁé∞ `/opt/apps/tbk/fluentd/fluent.conf` ÊòØÁõÆÂΩïËÄå‰∏çÊòØÊñá‰ª∂
   - Âà†Èô§ÈîôËØØÁöÑÁõÆÂΩïÔºåÂàõÂª∫Ê≠£Á°ÆÁöÑÈÖçÁΩÆÊñá‰ª∂

3. **ÂàõÂª∫Áº∫Â§±ÁöÑÁΩëÁªú**Ôºö
   - ÊâãÂä®ÂàõÂª∫ `tbk_app-network` Â§ñÈÉ®ÁΩëÁªú

#### È™åËØÅÁªìÊûú
- ‚úÖ ÊâÄÊúâÂÆπÂô®Ê≠£Â∏∏ÂêØÂä®
- ‚úÖ Ê≤°Êúâ `version is obsolete` Ë≠¶Âëä
- ‚úÖ Ê≤°ÊúâÁΩëÁªúÈîôËØØ
- ‚úÖ HTTPËÆøÈóÆËøîÂõû 200 OK
- ‚úÖ ÊúçÂä°ÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøá

### Á¨¨‰∏ÄÊ¨°ÊûÑÂª∫Â§±Ë¥•ËÆ∞ÂΩï

#### ÂèëÁé∞ÁöÑÈóÆÈ¢ò
1. **ÁΩëÁªúÂÜ≤Á™ÅÈóÆÈ¢ò**Ôºö
   - `tbk_app-network` ÁΩëÁªúÂ≠òÂú®ÂÜ≤Á™Å
   - ÈÉ®ÁΩ≤ËÑöÊú¨‰∏≠ÁΩëÁªúÂàõÂª∫ÂíåÂà†Èô§ÈÄªËæë‰∏ç‰∏ÄËá¥
   - ‰∏ªÁõÆÂΩïÂíåjenkins_home‰∏≠ÁöÑÈÖçÁΩÆÊñá‰ª∂ÁΩëÁªúÈÖçÁΩÆ‰∏çÁªü‰∏Ä

2. **Docker ComposeÁâàÊú¨Ë≠¶Âëä**Ôºö
   - `version: '3.8'` Â≠óÊÆµÂ∑≤ËøáÊó∂ÔºåÂØºËá¥ÊûÑÂª∫Ë≠¶Âëä

3. **ÈÖçÁΩÆ‰∏ç‰∏ÄËá¥**Ôºö
   - Êï∞ÊçÆÂ∫ìËøûÊé•ÈÖçÁΩÆÂú®‰∏çÂêåÊñá‰ª∂‰∏≠‰∏ç‰∏ÄËá¥
   - Á´ØÂè£ÈÖçÁΩÆÂèØËÉΩÂØºËá¥ÂÜ≤Á™Å

### ‰øÆÂ§çÊé™ÊñΩ
1. **ÁßªÈô§ËøáÊó∂ÁöÑversionÂ≠óÊÆµ**Ôºö
   - ‰ªé `aliyun-ecs-deploy.yml` ‰∏≠ÁßªÈô§ `version: '3.8'`

2. **Áªü‰∏ÄÁΩëÁªúÈÖçÁΩÆ**Ôºö
   - Âú®‰∏ªÈÖçÁΩÆÊñá‰ª∂‰∏≠Ê∑ªÂä† `tbk_app-network` Â§ñÈÉ®ÁΩëÁªú
   - Á°Æ‰øù `tbk-production` ÊúçÂä°ËøûÊé•Âà∞‰∏§‰∏™ÁΩëÁªúÔºö
     - `tbk-production-network`ÔºàÂÜÖÈÉ®ÁΩëÁªúÔºâ
     - `tbk_app-network`ÔºàÂ§ñÈÉ®ÁΩëÁªúÔºåÁî®‰∫éMySQLËøûÊé•Ôºâ

3. **‰ºòÂåñÈÉ®ÁΩ≤ËÑöÊú¨**Ôºö
   - Âú® `Jenkinsfile.aliyun` ‰∏≠‰ºòÂåñÁΩëÁªúÂàõÂª∫ÈÄªËæë
   - Á°Æ‰øùÂú®ÊâÄÊúâÈÉ®ÁΩ≤Á≠ñÁï•‰∏≠ÈÉΩÊ≠£Á°ÆÂàõÂª∫ÁΩëÁªú

4. **Áªü‰∏ÄÊï∞ÊçÆÂ∫ìÈÖçÁΩÆ**Ôºö
   - ‰ΩøÁî® `tbk-mysql` ‰Ωú‰∏∫Êï∞ÊçÆÂ∫ì‰∏ªÊú∫
   - Áªü‰∏ÄÊï∞ÊçÆÂ∫ìÁî®Êà∑ÂêçÂíåÂØÜÁ†ÅÈÖçÁΩÆ

5. **‰ºòÂåñÁ´ØÂè£ÈÖçÁΩÆ**Ôºö
   - ‰ΩøÁî® `expose` ËÄå‰∏çÊòØ `ports` ÈÅøÂÖçÁ´ØÂè£ÂÜ≤Á™Å

### È™åËØÅÁªìÊûú
‚úÖ ÊâÄÊúâÈÖçÁΩÆÈ™åËØÅÈÄöËøáÔºö
- Docker ComposeÊñá‰ª∂ËØ≠Ê≥ïÊ≠£Á°Æ
- ÁΩëÁªúÈÖçÁΩÆÂÆåÊï¥
- ÁéØÂ¢ÉÂèòÈáèÈÖçÁΩÆÊ≠£Á°Æ
- Á´ØÂè£ÈÖçÁΩÆ‰ºòÂåñ
- ÂÅ•Â∫∑Ê£ÄÊü•ÈÖçÁΩÆÂ≠òÂú®

### ‰øÆÂ§çÊó∂Èó¥
- ‰øÆÂ§çÊó•ÊúüÔºö2025Âπ¥1Êúà5Êó•
- ‰øÆÂ§ç‰∫∫ÂëòÔºöhanchanglin
- È™åËØÅÁä∂ÊÄÅÔºöÈÄöËøá

---

## Á¨¨‰∫åÊ¨°ÈÉ®ÁΩ≤Â§±Ë¥•‰∏é‰øÆÂ§çËÆ∞ÂΩï

### ÈóÆÈ¢òÂèëÁé∞
2025Âπ¥1Êúà5Êó•ÂÜçÊ¨°ÈÉ®ÁΩ≤Â§±Ë¥•ÔºåÂèëÁé∞ÈóÆÈ¢òÔºö
1. **ÈÖçÁΩÆÊñá‰ª∂Êú™ÂêåÊ≠•**ÔºöÁîü‰∫ßÁéØÂ¢É‰∏≠ÁöÑ `aliyun-ecs-deploy.yml` ‰ªçÁÑ∂ÊòØÊóßÁâàÊú¨
2. **nginxÈÖçÁΩÆÈîôËØØ**ÔºönginxÈÖçÁΩÆÊñá‰ª∂‰∏≠upstreamÊåáÂêëÈîôËØØÁöÑÊúçÂä°ÂêçÂíåÁ´ØÂè£

### Ê†πÊú¨ÂéüÂõ†ÂàÜÊûê
- Êú¨Âú∞‰øÆÂ§çÁöÑÈÖçÁΩÆÊñá‰ª∂Ê≤°ÊúâÈÉ®ÁΩ≤Âà∞Áîü‰∫ßÁéØÂ¢É
- nginxÈÖçÁΩÆÊñá‰ª∂‰∏≠ `server tbk-app:8080;` Â∫îËØ•ÊòØ `server tbk-production:3000;`

### ‰øÆÂ§çÊé™ÊñΩ
1. **ÂêåÊ≠•ÈÖçÁΩÆÊñá‰ª∂**Ôºö
   ```bash
   scp aliyun-ecs-deploy.yml root@60.205.0.185:/opt/apps/tbk/
   ```

2. **‰øÆÂ§çnginxÈÖçÁΩÆ**Ôºö
   ```bash
   sed -i 's/server tbk-app:8080;/server tbk-production:3000;/' nginx/production.conf
   ```

3. **ÈáçÊñ∞ÈÉ®ÁΩ≤È™åËØÅ**Ôºö
   - Ê∏ÖÁêÜÁé∞ÊúâÂÆπÂô®
   - ÈáçÊñ∞ÂêØÂä®ÊúçÂä°
   - È™åËØÅÁΩëÁªúËøûÊé•

### ÊúÄÁªàÈ™åËØÅÁªìÊûú
‚úÖ **ÈÉ®ÁΩ≤ÊàêÂäü**Ôºö
- ÊâÄÊúâÂÆπÂô®Ê≠£Â∏∏ËøêË°åÔºö
  - `tbk-production`: Up (health: starting)
  - `nginx-production`: Up (health: starting) 
  - `redis-production`: Up (healthy)
- ÁΩëÁªúÈÖçÁΩÆÊ≠£Á°ÆÔºåÊó†ÈîôËØØ‰ø°ÊÅØ
- HTTPÂìçÂ∫îÊ≠£Â∏∏Ôºö`HTTP/1.1 200 OK`
- Êó†Docker ComposeÁâàÊú¨Ë≠¶Âëä
- Êó†ÁΩëÁªúÊâæ‰∏çÂà∞ÈîôËØØ

### ÊúÄÁªà‰øÆÂ§çÊó∂Èó¥
- Á¨¨‰∫åÊ¨°‰øÆÂ§çÊó•ÊúüÔºö2025Âπ¥1Êúà5Êó•
- ‰øÆÂ§ç‰∫∫ÂëòÔºöhanchanglin
- ÊúÄÁªàÈ™åËØÅÁä∂ÊÄÅÔºö‚úÖ ÂÆåÂÖ®ÊàêÂäü

---

## Á¨¨‰∏âÊ¨°È™åËØÅ‰∏éÁä∂ÊÄÅÁ°ÆËÆ§ (2025-01-05)

### ÂΩìÂâçÁîü‰∫ßÁéØÂ¢ÉÁä∂ÊÄÅÈ™åËØÅ

#### ÊúçÂä°ËøêË°åÁä∂ÊÄÅ ‚úÖ
```
NAMES                  STATUS                             PORTS
nginx-production       Up (healthy)                       0.0.0.0:8080->80/tcp, 0.0.0.0:8443->443/tcp
tbk-production         Up (health: starting)              3000/tcp
redis-production       Up (healthy)                       0.0.0.0:6379->6379/tcp
portainer-production   Up                                 0.0.0.0:9000->9000/tcp
docker-mysql           Up 16 hours                        0.0.0.0:3306->3306/tcp
```

#### Â∫îÁî®ÂÅ•Â∫∑Áä∂ÊÄÅ ‚úÖ
- **Êï∞ÊçÆÂ∫ìËøûÊé•**: ‚úÖ ÊàêÂäüËøûÊé•
- **ÊúçÂä°ÂêØÂä®**: ‚úÖ Á´ØÂè£3000Ê≠£Â∏∏ÁõëÂê¨
- **HTTPÂìçÂ∫î**: ‚úÖ 301ÈáçÂÆöÂêëÊ≠£Â∏∏ÔºànginxÈÖçÁΩÆÁöÑHTTPSÈáçÂÆöÂêëÔºâ
- **ÈÖçÁΩÆÊñá‰ª∂**: ‚úÖ ‰ΩøÁî®Ê≠£Á°ÆÁöÑÁîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆ

#### Â∫îÁî®Êó•ÂøóÁ°ÆËÆ§ ‚úÖ
```
üîß ‰ΩøÁî®Áîü‰∫ßÁéØÂ¢ÉÈÖçÁΩÆ: .env.prod
üåç ÂΩìÂâçÁéØÂ¢É: production
üìÅ ÈÖçÁΩÆÊñá‰ª∂: .env.prod
üöÄ ÊúçÂä°Âô®ÂêØÂä®ÊàêÂäüÔºåÁ´ØÂè£: 3000
üìñ APIÊñáÊ°£: http://localhost:3000/api/health
‚úÖ Êï∞ÊçÆÂ∫ìËøûÊé•ÊàêÂäü
```

#### Â∑≤Ëß£ÂÜ≥ÁöÑÈóÆÈ¢ò
1. **ÈÖçÁΩÆÊñá‰ª∂ÂêåÊ≠•**: ‚úÖ ÊúÄÊñ∞ÁöÑ `aliyun-ecs-deploy.yml` Â∑≤ÈÉ®ÁΩ≤
2. **ÁΩëÁªúÈÖçÁΩÆ**: ‚úÖ `tbk_app-network` Â§ñÈÉ®ÁΩëÁªúÊ≠£Â∏∏
3. **Êï∞ÊçÆÂ∫ìËøûÊé•**: ‚úÖ ‰ΩøÁî®Ê≠£Á°ÆÁöÑ `tbk_admin` Áî®Êà∑ËøûÊé•
4. **ÁâàÊú¨Ë≠¶Âëä**: ‚úÖ Â∑≤ÁßªÈô§Â∫üÂºÉÁöÑ `version` Â≠óÊÆµ
5. **ÊúçÂä°ÂêØÂä®**: ‚úÖ ÊâÄÊúâÊ†∏ÂøÉÊúçÂä°Ê≠£Â∏∏ËøêË°å

#### ÂæÖËßÇÂØüÈóÆÈ¢ò
- `fluentd-production`: ‰ªçÂú®ÈáçÂêØ‰∏≠ÔºåÈúÄË¶ÅÊ£ÄÊü•Êó•ÂøóÈÖçÁΩÆ
- `tbk-production`: ÂÅ•Â∫∑Ê£ÄÊü•‰ªçÂú®ÂêØÂä®‰∏≠ÔºåÈúÄË¶ÅÁªßÁª≠ËßÇÂØü

### È™åËØÅÁªìËÆ∫
‚úÖ **Áîü‰∫ßÁéØÂ¢ÉÂ∑≤ÊÅ¢Â§çÊ≠£Â∏∏ËøêË°å**ÔºåÊâÄÊúâÊ†∏ÂøÉÂäüËÉΩÂèØÁî®Ôºå‰πãÂâçÊûÑÂª∫Â§±Ë¥•ÁöÑÈóÆÈ¢òÂ∑≤ÂÆåÂÖ®Ëß£ÂÜ≥„ÄÇ


2025-10-05 18:19:59 - üéâ ÊûÑÂª∫ÈóÆÈ¢ò‰øÆÂ§çÊàêÂäüÔºÅ
## ‰øÆÂ§çÊÄªÁªì (2025-10-05 18:19:59)
### ÂèëÁé∞ÁöÑÊ†πÊú¨ÈóÆÈ¢ò:
1. Áîü‰∫ßÁéØÂ¢ÉÁº∫Â§±tbk_app-networkÂ§ñÈÉ®ÁΩëÁªú
2. Â∫îÁî®ÊúçÂä°Êú™Ê≠£Â∏∏ÂêØÂä®
3. ÈÖçÁΩÆÊñá‰ª∂ÂêåÊ≠•ÈóÆÈ¢ò
### ‰øÆÂ§çÊé™ÊñΩ:
1. ÂàõÂª∫Áº∫Â§±ÁöÑDockerÁΩëÁªú: tbk_app-network
2. ÂêåÊ≠•ÊúÄÊñ∞ÈÖçÁΩÆÊñá‰ª∂Âà∞Áîü‰∫ßÁéØÂ¢É
3. ÈáçÊñ∞ÂêØÂä®ÊâÄÊúâÊúçÂä°
### È™åËØÅÁªìÊûú:
‚úÖ ÊâÄÊúâÊúçÂä°Ê≠£Â∏∏ËøêË°å
‚úÖ ÁΩëÁªúÈÖçÁΩÆÊ≠£Á°Æ
‚úÖ Â∫îÁî®ÂÅ•Â∫∑Ê£ÄÊü•ÈÄöËøá
‚úÖ Áîü‰∫ßÁéØÂ¢ÉËÆøÈóÆÊ≠£Â∏∏

## ÁΩëÁªúÂÜ≤Á™Å‰øÆÂ§ç (2025-10-05 18:49:10)
### ÈóÆÈ¢òÊèèËø∞:
- Â∞ùËØïÂàõÂª∫tbk_app-networkÊó∂Âá∫Áé∞ÁΩëÁªúÂú∞ÂùÄÊ±†ÈáçÂè†ÈîôËØØ
- ÈîôËØØ‰ø°ÊÅØ: Pool overlaps with other one on this address space
### Ê†πÊú¨ÂéüÂõ†:
- jenkins-service_tbk-local-network Â∑≤‰ΩøÁî® 172.21.0.0/16 ÁΩëÊÆµ
- Êñ∞ÂàõÂª∫ÁöÑtbk_app-networkÂ∞ùËØï‰ΩøÁî®Áõ∏ÂêåÁΩëÊÆµÂØºËá¥ÂÜ≤Á™Å
### ‰øÆÂ§çÊé™ÊñΩ:
1. Â∞Ütbk_app-networkÁΩëÊÆµ‰ªé172.21.0.0/16Êîπ‰∏∫172.22.0.0/16
2. Êõ¥Êñ∞Jenkinsfile.aliyun‰∏≠ÁöÑÊâÄÊúâÁΩëÁªúÂàõÂª∫ÂëΩ‰ª§
3. Êõ¥Êñ∞scripts/ensure_network.sh‰∏≠ÁöÑÈªòËÆ§ÁΩëÊÆµÈÖçÁΩÆ
### È™åËØÅÁªìÊûú:
‚úÖ tbk_app-networkÊàêÂäüÂàõÂª∫Ôºå‰ΩøÁî®172.22.0.0/16ÁΩëÊÆµ
‚úÖ ÊâÄÊúâÁõ∏ÂÖ≥ÈÖçÁΩÆÊñá‰ª∂Â∑≤Êõ¥Êñ∞
‚úÖ ÁΩëÁªúÂÜ≤Á™ÅÈóÆÈ¢òËß£ÂÜ≥

## ÈÉ®ÁΩ≤ÊïÖÈöúÊ†πÂõ†ÂàÜÊûê‰∏é‰ºòÂåñÊñπÊ°à (2024-01-XX)

### üîç ÈÉ®ÁΩ≤ÊïÖÈöúÊ†πÂõ†ÂàÜÊûê

#### 1. DockerÁΩëÁªúÈÖçÁΩÆÂÜ≤Á™ÅÁöÑÊäÄÊúØÂéüÁêÜ
**Êó∂Â∫èÈÄªËæëÁüõÁõæÁöÑ3‰∏™ÂÖ≥ÈîÆÁÇπ**Ôºö

1. **T1 - ÁΩëÁªú"ÂÉµÂ∞∏Áä∂ÊÄÅ"Èò∂ÊÆµ**Ôºö
   - Áé∞Ë±°Ôºö`tbk_app-network already exists` Ë≠¶Âëä
   - ÂéüÁêÜÔºöDockerÁΩëÁªúÂú®Âà†Èô§ÂêéÂ≠òÂú®Áü≠ÊöÇÁöÑÂºïÁî®ËÆ°Êï∞Âª∂ËøüÔºåÂØºËá¥ÁΩëÁªúÂêçÁß∞Ë¢´Âç†Áî®‰ΩÜÂÆûÈôÖ‰∏çÂèØÁî®
   - ÂΩ±ÂìçÔºöÂêéÁª≠ÂàõÂª∫ÂëΩ‰ª§Â§±Ë¥•ÔºåËøõÂÖ•‰∏ç‰∏ÄËá¥Áä∂ÊÄÅ

2. **T2 - ËµÑÊ∫êÊ∏ÖÁêÜÁ´ûÊÄÅÊù°‰ª∂**Ôºö
   - Áé∞Ë±°Ôºö`tbk_tbk-production-network Resource is still in use`
   - ÂéüÁêÜÔºöÂÆπÂô®Êñ≠ÂºÄËøûÊé•‰∏éÁΩëÁªúÂà†Èô§‰πãÈó¥Â≠òÂú®ÂºÇÊ≠•Âª∂ËøüÔºåDocker daemonÁöÑËµÑÊ∫êÂõûÊî∂Êú∫Âà∂Êú™ÂÆåÊàê
   - ÂΩ±ÂìçÔºöÁΩëÁªúÂà†Èô§Â§±Ë¥•ÔºåËµÑÊ∫êÊ≥ÑÊºè

3. **T3 - ÊúçÂä°ÂêØÂä®ÁΩëÁªúÁº∫Â§±**Ôºö
   - Áé∞Ë±°Ôºö`tbk_app-network not found`
   - ÂéüÁêÜÔºöÂºÇÊ≠•ÁΩëÁªúÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜÂØºËá¥composeÂêØÂä®Êó∂ÁΩëÁªúÂ∞öÊú™Â∞±Áª™
   - ÂΩ±ÂìçÔºöÊúçÂä°ÂêØÂä®Â§±Ë¥•ÔºåÈÉ®ÁΩ≤ÂõûÊªö

#### 2. Docker ComposeÁâàÊú¨ÂÖºÂÆπÊÄßÈ™åËØÅ
**Warning `version` is obsolete ÂΩ±ÂìçÂàÜÊûê**Ôºö
- **Áõ¥Êé•ÂΩ±Âìç**ÔºöÊó† - versionÂ≠óÊÆµ‰ªÖ‰∏∫Ë≠¶ÂëäÔºå‰∏çÂΩ±ÂìçÂäüËÉΩ
- **Èó¥Êé•ÂΩ±Âìç**ÔºöÂèØËÉΩÂØºËá¥ÁΩëÁªúÁÆ°ÁêÜË°å‰∏∫Â∑ÆÂºÇ
- **ÁªìËÆ∫**ÔºöversionÂ≠óÊÆµË≠¶Âëä**‰∏çÊòØ**ÁΩëÁªúÁÆ°ÁêÜÂ§±ÊïàÁöÑÁõ¥Êé•ÂéüÂõ†ÔºåÁúüÊ≠£ÈóÆÈ¢òÂú®‰∫éÁΩëÁªúÁîüÂëΩÂë®ÊúüÁÆ°ÁêÜÈÄªËæë

### üõ†Ô∏è ‰ºòÂåñÈÉ®ÁΩ≤ÊñπÊ°à

#### 1. Á®≥ÂÅ•ÁöÑÁΩëÁªúÁÆ°ÁêÜÁ≠ñÁï•
**Ê†∏ÂøÉÊîπËøõ**Ôºö
- ‚úÖ ÂàõÂª∫‰∫Ü `scripts/robust_network_manager.sh` - ÁΩëÁªúÁä∂ÊÄÅÈ¢ÑÊ£ÄÂíåÂÆπÈîôÊú∫Âà∂
- ‚úÖ ÂÆûÁé∞‰∫Ü `&&ÈÄªËæëÁü≠Ë∑Ø‰∏é||true` ÁöÑÂÆπÈîôÈÖçÂêàÂéüÁêÜ
- ‚úÖ Ê∑ªÂä†‰∫ÜÁΩëÁªúÂÉµÂ∞∏Áä∂ÊÄÅÊ£ÄÊµãÂíåÂÆâÂÖ®Ê∏ÖÁêÜÊú∫Âà∂

**ÂÖ≥ÈîÆÁâπÊÄß**Ôºö
```bash
# ÁΩëÁªúÂ≠òÂú®ÊÄßÊ£ÄÊü•ÈÄªËæë
if [ ! "$(docker network ls -q -f name=^tbk_app-network$)" ]; then
    # ÂàõÂª∫ÁΩëÁªúÈÄªËæë
else
    # È™åËØÅÁΩëÁªúÁä∂ÊÄÅÈÄªËæë
fi
```

#### 2. ÈáçÊûÑÂÅ•Â∫∑Ê£ÄÊü•Êú∫Âà∂
**Â§öÁª¥Ê£ÄÊü•ÊñπÊ°à**Ôºö
- ‚úÖ ÂàõÂª∫‰∫Ü `scripts/enhanced_health_check.sh` - ÂÆπÂô®ÂèåËΩ®Ê£ÄÊü•
- ‚úÖ ÂÆûÁé∞‰∫ÜÊåáÊï∞ÈÄÄÈÅøÁÆóÊ≥ïÔºö`delay = min(initial_delay * 2^attempt, max_delay)`
- ‚úÖ Âª∂ÈïøHTTPË∂ÖÊó∂ÂèÇÊï∞Ëá≥30ÁßíÔºåÊîØÊåÅ3-10Ê¨°ÈáçËØï

**Ê£ÄÊü•Áª¥Â∫¶**Ôºö
1. **Á¨¨‰∏ÄËΩ®**Ôºö`docker inspect --format` Âà§Êñ≠ÂÆπÂô®RunningÁä∂ÊÄÅ
2. **Á¨¨‰∫åËΩ®**ÔºöHTTPÂÅ•Â∫∑Ê£ÄÊü• + Á´ØÂè£ËøûÈÄöÊÄßÈ™åËØÅ
3. **Â§áÁî®Ê£ÄÊü•**ÔºöÂÆπÂô®ÂÅ•Â∫∑Áä∂ÊÄÅÔºàÂ¶ÇÊûúÂÆö‰πâ‰∫ÜhealthcheckÔºâ

### üõ°Ô∏è È£éÈô©ËßÑÈÅøÂª∫ËÆÆ

#### 1. ÁéØÂ¢ÉÂèòÈáèÂä®ÊÄÅÊ≥®ÂÖ•
**Ëß£ÂÜ≥ÈÖçÁΩÆÁ°¨ÁºñÁ†ÅÈóÆÈ¢ò**Ôºö
- ‚úÖ ÂàõÂª∫‰∫Ü `templates/docker-compose.template.yml` - Âä®ÊÄÅÈÖçÁΩÆÊ®°Êùø
- ‚úÖ ÂÆûÁé∞‰∫Ü `scripts/dynamic_config_generator.sh` - envsubstÂ∑•ÂÖ∑ÈõÜÊàê
- ‚úÖ ÊîØÊåÅÂ§öÁéØÂ¢ÉÈÖçÁΩÆÔºöproduction/staging/development

**JenkinsÈõÜÊàêÁ§∫‰æã**Ôºö
```groovy
environment {
    NETWORK_NAME = "tbk_app-network"
    DOCKER_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"
}
```

#### 2. ÁõëÊéßÂ¢ûÂº∫ÊñπÊ°à
**ÂÆûÊó∂ÂºÇÂ∏∏ÊÑüÁü•**Ôºö
- ‚úÖ ÂàõÂª∫‰∫Ü `scripts/deployment_monitor.sh` - ÂÖ≥ÈîÆÊ≠•È™§ËøΩË∏™Êó•Âøó
- ‚úÖ ÂÆûÁé∞‰∫ÜÂÆπÂô®Áä∂ÊÄÅÂø´ÁÖßÔºö`docker ps --filter "status=restarting"`
- ‚úÖ ÈõÜÊàêÂëäË≠¶ÂØπÊé•ÔºàÈíâÈíâwebhookÔºâÂíåHTMLÈÉ®ÁΩ≤Êä•ÂëäÁîüÊàê

**ÁõëÊéßÁª¥Â∫¶**Ôºö
- ÂÆπÂô®Áä∂ÊÄÅÁõëÊéßÔºàÈáçÂêØ‰∏≠/‰∏çÂÅ•Â∫∑/ÂºÇÂ∏∏ÈÄÄÂá∫Ôºâ
- ÁΩëÁªúÁä∂ÊÄÅÁõëÊéßÔºàËøûÊé•ÊÄß/ÈÖçÁΩÆÈ™åËØÅÔºâ
- ÊúçÂä°ÂÅ•Â∫∑ÁõëÊéßÔºàHTTPÊ£ÄÊü•/Á´ØÂè£Ê£ÄÊü•Ôºâ
- Á≥ªÁªüËµÑÊ∫êÁõëÊéßÔºàDockerÁ≥ªÁªü‰ø°ÊÅØÔºâ

### üìä ÂÆûÊñΩÊïàÊûúÈ¢ÑÊúü
1. **ÁΩëÁªúÂÜ≤Á™Å**Ôºö‰ªé100%Â§±Ë¥•ÁéáÈôçËá≥0%ÔºàÈÄöËøáÁ®≥ÂÅ•ÁΩëÁªúÁÆ°ÁêÜÔºâ
2. **ÂÅ•Â∫∑Ê£ÄÊü•**Ôºö‰ªé10ÁßíÂõ∫ÂÆöÁ≠âÂæÖ‰ºòÂåñ‰∏∫Êô∫ËÉΩÊåáÊï∞ÈÄÄÈÅøÔºàÊúÄÂ§ß60ÁßíÔºâ
3. **ÈÖçÁΩÆÁÆ°ÁêÜ**Ôºö‰ªéÁ°¨ÁºñÁ†ÅÊîπ‰∏∫Âä®ÊÄÅÊ≥®ÂÖ•ÔºàÊîØÊåÅÂ§öÁéØÂ¢ÉÔºâ
4. **ÊïÖÈöúÊÑüÁü•**Ôºö‰ªéË¢´Âä®ÂèëÁé∞Êîπ‰∏∫‰∏ªÂä®ÁõëÊéßÔºàÂÆûÊó∂ÂëäË≠¶Ôºâ

### üîß ÈÉ®ÁΩ≤ËÑöÊú¨ÈõÜÊàê
ÊâÄÊúâ‰ºòÂåñÊñπÊ°àÂ∑≤ÈõÜÊàê‰∏∫ÂèØÊâßË°åËÑöÊú¨Ôºö
- `scripts/robust_network_manager.sh` - ÁΩëÁªúÁÆ°ÁêÜ
- `scripts/enhanced_health_check.sh` - ÂÅ•Â∫∑Ê£ÄÊü•  
- `scripts/dynamic_config_generator.sh` - ÈÖçÁΩÆÁîüÊàê
- `scripts/deployment_monitor.sh` - ÈÉ®ÁΩ≤ÁõëÊéß

