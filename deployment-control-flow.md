# Jenkins 部署控制流程详解

## 🎯 三重安全控制机制

### 1. 参数控制层
```
┌─────────────────────────────────────────┐
│           Jenkins 构建参数               │
├─────────────────────────────────────────┤
│ ☐ CONFIRM_PRODUCTION_DEPLOY (默认false) │
│ ☑ AUTO_DEPLOY_ENABLED (默认true)        │
│ 📋 DEPLOY_STRATEGY (rolling/recreate)   │
└─────────────────────────────────────────┘
```

### 2. 分支控制层
```
Git 分支检查:
├── main/master 分支 ✅ → 继续检查
├── develop 分支 ❌ → 跳过部署
├── feature/* 分支 ❌ → 跳过部署
└── hotfix/* 分支 ❌ → 跳过部署
```

### 3. 条件组合层
```
部署执行条件 (必须同时满足):
┌─────────────────────────────────────────┐
│ CONFIRM_PRODUCTION_DEPLOY == true   AND │
│ AUTO_DEPLOY_ENABLED == true         AND │
│ GIT_BRANCH == 'main'|'master'           │
└─────────────────────────────────────────┘
                    ↓
              ✅ 执行部署
```

## 📊 不同场景下的行为表

| 场景 | CONFIRM | AUTO_DEPLOY | 分支 | 结果 | 说明 |
|------|---------|-------------|------|------|------|
| 正常部署 | ✅ true | ✅ true | main | 🚀 **部署** | 所有条件满足 |
| 开发阶段 | ❌ false | ✅ true | main | ⏸️ **跳过** | 未手动确认 |
| 维护期间 | ✅ true | ❌ false | main | ⏸️ **跳过** | 自动部署已禁用 |
| 功能分支 | ✅ true | ✅ true | feature/xxx | ⏸️ **跳过** | 非主分支 |
| 开发分支 | ✅ true | ✅ true | develop | ⏸️ **跳过** | 非主分支 |
| 全部关闭 | ❌ false | ❌ false | main | ⏸️ **跳过** | 所有开关都关闭 |

## 🔄 完整流程图

```
开始构建
    ↓
┌─────────────────┐
│   代码检出       │
│   构建镜像       │
│   推送到仓库     │
└─────────────────┘
    ↓
┌─────────────────┐
│ 检查部署条件     │
├─────────────────┤
│ 1. 分支检查      │
│ 2. 参数检查      │
│ 3. 开关检查      │
└─────────────────┘
    ↓
   条件满足？
    ├─ 是 → 执行部署 → 健康检查 → 部署成功
    └─ 否 → 跳过部署 → 构建完成
```

## 🛡️ 安全机制说明

### 默认安全策略
- **CONFIRM_PRODUCTION_DEPLOY**: 默认`false`，防止意外部署
- **AUTO_DEPLOY_ENABLED**: 默认`true`，但需要手动确认才生效
- **分支限制**: 只允许主分支部署，保护生产环境

### 紧急控制措施
1. **快速禁用**: 设置`AUTO_DEPLOY_ENABLED = false`
2. **分支隔离**: 在非主分支开发，自动跳过部署
3. **手动控制**: 每次部署都需要明确的手动确认

### 灵活性配置
- **开发环境**: 可以修改参数默认值
- **测试环境**: 可以放宽分支限制
- **生产环境**: 保持最严格的控制

## 🎮 实际操作指南

### 场景1: 正常生产部署
1. 确保代码在`main`分支
2. 推送代码触发构建
3. 在Jenkins界面勾选`CONFIRM_PRODUCTION_DEPLOY`
4. 确认`AUTO_DEPLOY_ENABLED`为true
5. 点击构建

### 场景2: 仅构建不部署
1. 推送代码触发构建
2. 保持`CONFIRM_PRODUCTION_DEPLOY`为false
3. Jenkins会构建镜像但跳过部署

### 场景3: 维护期间禁用部署
1. 在Jenkins项目配置中修改参数默认值
2. 设置`AUTO_DEPLOY_ENABLED`默认为false
3. 所有构建都会跳过部署阶段

### 场景4: 功能分支开发
1. 在`feature/xxx`分支开发
2. 推送代码会触发构建
3. 自动跳过部署（分支限制）
4. 可以安全地测试构建流程

## 📝 最佳实践建议

1. **生产环境**: 保持默认的严格控制
2. **测试环境**: 可以适当放宽限制
3. **开发环境**: 建议启用自动部署
4. **紧急修复**: 使用hotfix分支，合并到main后部署
5. **版本发布**: 通过main分支进行正式发布

## 🔧 自定义配置

如需修改控制逻辑，可以编辑以下文件：
- `Jenkinsfile.aliyun.auto-deploy`: 修改参数定义和条件逻辑
- `scripts/deploy-options.conf`: 修改部署策略配置
- `scripts/auto-deploy-webhook.sh`: 修改实际部署逻辑