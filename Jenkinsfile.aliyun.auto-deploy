pipeline {
    agent any
    
    parameters {
        booleanParam(
            name: 'CONFIRM_PRODUCTION_DEPLOY',
            defaultValue: false,
            description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (è°¨æ…æ“ä½œ)'
        )
        booleanParam(
            name: 'AUTO_DEPLOY_ENABLED',
            defaultValue: true,
            description: 'å¯ç”¨è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
        )
        choice(
            name: 'DEPLOY_STRATEGY',
            choices: ['rolling', 'recreate', 'blue-green'],
            description: 'éƒ¨ç½²ç­–ç•¥'
        )
    }
    
    environment {
        DOCKER_REGISTRY = 'crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com'
        IMAGE_NAME = 'hanchanglin/tbk'
        DOCKER_CREDENTIALS_ID = 'aliyun-acr-credentials'
        BUILD_NUMBER_TAG = "${env.BUILD_NUMBER}-${env.GIT_COMMIT.take(7)}"
        PRODUCTION_SERVER = 'localhost'  // ç”Ÿäº§æœåŠ¡å™¨åœ°å€
        HEALTH_CHECK_URL = 'http://localhost:3003/api/health'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ğŸ“¥ Checking out source code...'
                checkout scm
                script {
                    env.GIT_COMMIT = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
                    env.GIT_BRANCH = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
                }
                echo "ğŸŒ¿ Branch: ${env.GIT_BRANCH}"
                echo "ğŸ“ Commit: ${env.GIT_COMMIT}"
            }
        }
        
        stage('Build Application') {
            steps {
                echo 'ğŸ”¨ Building Docker image...'
                script {
                    // æ„å»ºDockeré•œåƒ
                    def image = docker.build("${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:${env.BUILD_NUMBER_TAG}")
                    
                    // åŒæ—¶æ‰“ä¸Šlatestæ ‡ç­¾
                    sh "docker tag ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:${env.BUILD_NUMBER_TAG} ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:latest"
                    
                    echo "âœ… Docker image built successfully"
                    echo "ğŸ·ï¸  Tags: ${env.BUILD_NUMBER_TAG}, latest"
                }
            }
        }
        
        stage('Push to Registry') {
            steps {
                echo 'ğŸ“¤ Pushing image to Aliyun ACR...'
                script {
                    docker.withRegistry("https://${env.DOCKER_REGISTRY}", env.DOCKER_CREDENTIALS_ID) {
                        // æ¨é€å¸¦ç‰ˆæœ¬å·çš„é•œåƒ
                        sh "docker push ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:${env.BUILD_NUMBER_TAG}"
                        
                        // æ¨é€latesté•œåƒ
                        sh "docker push ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:latest"
                    }
                }
                echo 'âœ… Image pushed to registry successfully'
            }
        }
        
        stage('Deploy to Production') {
            when {
                allOf {
                    expression { params.CONFIRM_PRODUCTION_DEPLOY == true }
                    expression { params.AUTO_DEPLOY_ENABLED == true }
                    expression { env.GIT_BRANCH == 'main' || env.GIT_BRANCH == 'master' }
                }
            }
            steps {
                echo 'ğŸš€ Deploying to Production Environment...'
                script {
                    try {
                        // æ‰§è¡Œè‡ªåŠ¨éƒ¨ç½²è„šæœ¬
                        sh '''
                            echo "å¼€å§‹ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨éƒ¨ç½²..."
                            
                            # è®¾ç½®è„šæœ¬æƒé™
                            chmod +x scripts/auto-deploy-webhook.sh
                            
                            # æ‰§è¡Œè‡ªåŠ¨éƒ¨ç½²
                            ./scripts/auto-deploy-webhook.sh
                        '''
                        
                        echo 'âœ… Production deployment completed successfully'
                        
                        // è®°å½•éƒ¨ç½²ä¿¡æ¯
                        sh '''
                            echo "éƒ¨ç½²ä¿¡æ¯è®°å½•:"
                            echo "æ„å»ºå·: ${BUILD_NUMBER}"
                            echo "Gitæäº¤: ${GIT_COMMIT}"
                            echo "é•œåƒæ ‡ç­¾: ${BUILD_NUMBER_TAG}"
                            echo "éƒ¨ç½²æ—¶é—´: $(date)"
                            echo "éƒ¨ç½²ç­–ç•¥: ${DEPLOY_STRATEGY}"
                        '''
                        
                    } catch (Exception e) {
                        echo "âŒ Production deployment failed: ${e.getMessage()}"
                        
                        // éƒ¨ç½²å¤±è´¥æ—¶çš„å¤„ç†
                        sh '''
                            echo "éƒ¨ç½²å¤±è´¥ï¼Œæ£€æŸ¥æœåŠ¡çŠ¶æ€..."
                            docker-compose -f docker-compose.production.yml ps || true
                            docker-compose -f docker-compose.production.yml logs --tail=50 tbk-production || true
                        '''
                        
                        throw e
                    }
                }
            }
        }
        
        stage('Post-Deploy Verification') {
            when {
                allOf {
                    expression { params.CONFIRM_PRODUCTION_DEPLOY == true }
                    expression { params.AUTO_DEPLOY_ENABLED == true }
                }
            }
            steps {
                echo 'ğŸ” Running post-deployment verification...'
                script {
                    // å¥åº·æ£€æŸ¥
                    sh '''
                        echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
                        max_attempts=10
                        attempt=1
                        
                        while [ $attempt -le $max_attempts ]; do
                            if curl -f ${HEALTH_CHECK_URL} > /dev/null 2>&1; then
                                echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ (å°è¯• $attempt/$max_attempts)"
                                break
                            fi
                            
                            echo "â³ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯•ä¸­... (å°è¯• $attempt/$max_attempts)"
                            sleep 15
                            attempt=$((attempt + 1))
                            
                            if [ $attempt -gt $max_attempts ]; then
                                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
                                exit 1
                            fi
                        done
                    '''
                    
                    // æœåŠ¡çŠ¶æ€æ£€æŸ¥
                    sh '''
                        echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
                        docker-compose -f docker-compose.production.yml ps
                        
                        echo "æ£€æŸ¥å®¹å™¨å¥åº·çŠ¶æ€..."
                        docker ps --filter "name=tbk-tbk-production" --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
                    '''
                    
                    echo 'âœ… Post-deployment verification completed'
                }
            }
        }
        
        stage('Build Only Summary') {
            when {
                expression { params.CONFIRM_PRODUCTION_DEPLOY != true }
            }
            steps {
                echo 'ğŸ“‹ æ„å»ºå®Œæˆ - ä»…æ„å»ºæ¨¡å¼'
                echo 'ğŸš« è·³è¿‡ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ï¼ˆæœªç¡®è®¤éƒ¨ç½²ï¼‰'
                echo 'âœ… Dockeré•œåƒå·²æ„å»ºå¹¶æ¨é€åˆ°é˜¿é‡Œäº‘ACR'
                echo 'ğŸ’¡ å¦‚éœ€éƒ¨ç½²ï¼Œè¯·é‡æ–°è¿è¡Œæ„å»ºå¹¶ç¡®è®¤ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²'
                
                script {
                    echo "ğŸ“¦ æ„å»ºä¿¡æ¯:"
                    echo "  - é•œåƒ: ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:${env.BUILD_NUMBER_TAG}"
                    echo "  - é•œåƒ: ${env.DOCKER_REGISTRY}/${env.IMAGE_NAME}:latest"
                    echo "  - Gitåˆ†æ”¯: ${env.GIT_BRANCH}"
                    echo "  - Gitæäº¤: ${env.GIT_COMMIT}"
                }
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ§¹ Cleaning up workspace...'
            sh '''
                # æ¸…ç†æœ¬åœ°æ„å»ºçš„é•œåƒï¼ˆä¿ç•™æœ€æ–°çš„å‡ ä¸ªï¼‰
                docker images ${DOCKER_REGISTRY}/${IMAGE_NAME} --format "table {{.ID}}\\t{{.CreatedAt}}" | \\
                tail -n +2 | sort -k2 -r | tail -n +6 | awk '{print $1}' | \\
                xargs -r docker rmi -f 2>/dev/null || true
                
                # æ¸…ç†æ‚¬ç©ºé•œåƒ
                docker image prune -f || true
                
                echo "æ¸…ç†å®Œæˆ"
            '''
        }
        
        success {
            echo 'ğŸ‰ Pipeline completed successfully!'
            script {
                if (params.CONFIRM_PRODUCTION_DEPLOY && params.AUTO_DEPLOY_ENABLED) {
                    echo 'âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æˆåŠŸ'
                    echo "ğŸŒ åº”ç”¨è®¿é—®åœ°å€: http://${env.PRODUCTION_SERVER}:3003"
                } else {
                    echo 'âœ… é•œåƒæ„å»ºæˆåŠŸï¼Œç­‰å¾…æ‰‹åŠ¨éƒ¨ç½²'
                }
            }
        }
        
        failure {
            echo 'âŒ Pipeline failed!'
            script {
                // å‘é€å¤±è´¥é€šçŸ¥
                sh '''
                    echo "æ„å»ºå¤±è´¥é€šçŸ¥:"
                    echo "  - æ„å»ºå·: ${BUILD_NUMBER}"
                    echo "  - åˆ†æ”¯: ${GIT_BRANCH}"
                    echo "  - æäº¤: ${GIT_COMMIT}"
                    echo "  - å¤±è´¥æ—¶é—´: $(date)"
                '''
            }
        }
        
        unstable {
            echo 'âš ï¸ Pipeline completed with warnings'
        }
    }
}