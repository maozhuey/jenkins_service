pipeline {
    agent any
    
    parameters {
        string(
            name: 'PROJECT',
            defaultValue: 'product-catalog',
            description: 'é¡¹ç›®æ ‡è¯†'
        )
        booleanParam(
            name: 'CONFIRM_PRODUCTION_DEPLOY',
            defaultValue: false,
            description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (è°¨æ…æ“ä½œ)'
        )
        booleanParam(
            name: 'AUTO_DEPLOY_ENABLED',
            defaultValue: true,
            description: 'å¯ç”¨è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
        )
        choice(
            name: 'DEPLOY_STRATEGY',
            choices: ['rolling', 'recreate'],
            description: 'éƒ¨ç½²ç­–ç•¥'
        )
    }
    
    environment {
        // é¡¹ç›®é…ç½®
        PROJECT_NAME = 'product-catalog'
        DOCKER_IMAGE = 'product-catalog'
        DOCKER_TAG = "${BUILD_NUMBER}"
        
        // é˜¿é‡Œäº‘é…ç½®
        DOCKER_REGISTRY = 'crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com'
        DOCKER_NAMESPACE = 'hanchanglin'
        ALIYUN_SERVER = '60.205.0.185'
        DEPLOY_PATH = '/opt/product-catalog'
        
        // æ„å»ºé…ç½®
        BUILD_NUMBER = "${env.BUILD_NUMBER}"
        GIT_COMMIT_SHORT = "${env.GIT_COMMIT?.take(7) ?: 'unknown'}"
        FULL_DOCKER_TAG = "${BUILD_NUMBER}-${GIT_COMMIT_SHORT}"
        
        // å¥åº·æ£€æŸ¥
        HEALTH_CHECK_URL = "http://${ALIYUN_SERVER}:3000/api/health"
    }
    
    stages {
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                echo 'ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ...'
                script {
                    sh 'docker --version'
                    sh 'node --version'
                    sh 'npm --version'
                    echo "æ„å»ºåˆ†æ”¯: ${env.GIT_BRANCH}"
                    echo "æäº¤ID: ${GIT_COMMIT_SHORT}"
                    echo "æ„å»ºå·: ${BUILD_NUMBER}"
                }
            }
        }
        
        stage('ä»£ç æ£€å‡º') {
            steps {
                echo 'ğŸ“¥ æ£€å‡ºä»£ç ...'
                checkout scm
                script {
                    sh 'ls -la'
                    sh 'pwd'
                }
            }
        }
        
        stage('å‰ç«¯æ„å»º') {
            steps {
                echo 'ğŸ¨ æ„å»ºå‰ç«¯é™æ€æ–‡ä»¶...'
                script {
                    // æ£€æŸ¥å‰ç«¯æ–‡ä»¶
                    sh 'ls -la js/ css/ || echo "é™æ€æ–‡ä»¶ç›®å½•æ£€æŸ¥å®Œæˆ"'
                    
                    // å¦‚æœæœ‰package.jsonï¼Œæ‰§è¡Œnpmæ„å»º
                    if (fileExists('package.json')) {
                        sh 'npm install'
                        sh 'npm run build || echo "è·³è¿‡å‰ç«¯æ„å»ºæ­¥éª¤"'
                    }
                }
            }
        }
        
        stage('åç«¯æ„å»º') {
            steps {
                echo 'âš™ï¸ æ„å»ºåç«¯æœåŠ¡...'
                script {
                    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨package.jsonæ–‡ä»¶
                    if (fileExists('package.json')) {
                        sh 'npm install --production'
                        sh 'npm test || echo "è·³è¿‡æµ‹è¯•æ­¥éª¤"'
                    } else {
                        echo 'è·³è¿‡åç«¯æ„å»ºæ­¥éª¤ - æœªæ‰¾åˆ°package.json'
                    }
                }
            }
        }
        
        stage('Dockeré•œåƒæ„å»º') {
            steps {
                echo 'ğŸ³ åˆå§‹åŒ–Docker buildxç¯å¢ƒ...'
                script {
                    // å…ˆç»Ÿä¸€åˆå§‹åŒ–buildxç¯å¢ƒï¼Œé¿å…å¹¶è¡Œå†²çª
                    sh """
                        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„builder
                        docker buildx rm multiarch-builder || true
                        
                        # åˆ›å»ºæ–°çš„builder
                        docker buildx create --use --name multiarch-builder --driver docker-container
                        
                        # å¯åŠ¨builder
                        docker buildx inspect --bootstrap
                    """
                }
                
                // ä¸²è¡Œæ„å»ºï¼Œé¿å…èµ„æºå†²çª
                parallel {
                    stage('æ„å»ºå‰ç«¯é•œåƒ') {
                        steps {
                            echo 'ğŸ¨ æ„å»ºå‰ç«¯Dockeré•œåƒ (AMD64æ¶æ„)...'
                            script {
                                docker.withRegistry("https://${DOCKER_REGISTRY}", 'aliyun-acr') {
                                    sh """
                                        # åªæ„å»ºAMD64æ¶æ„ï¼Œé¿å…èµ„æºå†²çªï¼Œä½¿ç”¨æ ¹ç›®å½•çš„Dockerfile.frontend
                                        docker buildx build --platform linux/amd64 \
                                            -f Dockerfile.frontend \
                                            -t ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${DOCKER_IMAGE}-frontend:${FULL_DOCKER_TAG} \
                                            -t ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${DOCKER_IMAGE}-frontend:latest \
                                            --push .
                                    """
                                }
                            }
                        }
                    }
                    stage('æ„å»ºåç«¯é•œåƒ') {
                        steps {
                            echo 'âš™ï¸ æ„å»ºåç«¯Dockeré•œåƒ (AMD64æ¶æ„)...'
                            script {
                                docker.withRegistry("https://${DOCKER_REGISTRY}", 'aliyun-acr') {
                                    sh """
                                        # åªæ„å»ºAMD64æ¶æ„ï¼Œé¿å…èµ„æºå†²çªï¼Œä½¿ç”¨æ ¹ç›®å½•çš„Dockerfile.backend
                                        docker buildx build --platform linux/amd64 \
                                            -f Dockerfile.backend \
                                            -t ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${DOCKER_IMAGE}-backend:${FULL_DOCKER_TAG} \
                                            -t ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${DOCKER_IMAGE}-backend:latest \
                                            --push .
                                    """
                                }
                            }
                        }
                    }
                }
            }
            post {
                always {
                    script {
                        // æ¸…ç†buildxç¯å¢ƒ
                        sh 'docker buildx rm multiarch-builder || true'
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²ç¡®è®¤') {
            when {
                expression { params.CONFIRM_PRODUCTION_DEPLOY == true }
            }
            steps {
                script {
                    def userInput = input(
                        id: 'deployConfirm',
                        message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ',
                        parameters: [
                            choice(
                                name: 'DEPLOY_CONFIRM',
                                choices: ['å–æ¶ˆ', 'ç¡®è®¤éƒ¨ç½²'],
                                description: 'è¯·ç¡®è®¤æ˜¯å¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
                            )
                        ]
                    )
                    
                    if (userInput != 'ç¡®è®¤éƒ¨ç½²') {
                        error('ç”¨æˆ·å–æ¶ˆäº†éƒ¨ç½²æ“ä½œ')
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²åˆ°é˜¿é‡Œäº‘') {
            when {
                anyOf {
                    expression { params.AUTO_DEPLOY_ENABLED == true }
                    expression { params.CONFIRM_PRODUCTION_DEPLOY == true }
                }
            }
            steps {
                echo 'ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨...'
                script {
                    // å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨
                    sh """
                        echo "å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
                        scp -o StrictHostKeyChecking=no docker-compose.yml root@${ALIYUN_SERVER}:${DEPLOY_PATH}/
                        scp -o StrictHostKeyChecking=no .env.docker root@${ALIYUN_SERVER}:${DEPLOY_PATH}/.env
                    """
                    
                    // åœ¨æœåŠ¡å™¨ä¸Šéƒ¨ç½²
                    def deployStrategy = params.DEPLOY_STRATEGY ?: 'rolling'
                    
                    sh """
                        echo "å¼€å§‹${deployStrategy}éƒ¨ç½²..."
                        ssh -o StrictHostKeyChecking=no root@${ALIYUN_SERVER} '
                            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º
                            cd ${DEPLOY_PATH}
                            
                            # æ£€æŸ¥ç³»ç»Ÿèµ„æº
                            echo "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."
                            free -h
                            df -h
                            
                            # æ£€æŸ¥DockerçŠ¶æ€
                            echo "æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€..."
                            systemctl is-active docker || (echo "DockeræœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..." && systemctl start docker)
                            
                            # åˆ›å»ºå¤‡ä»½
                            echo "åˆ›å»ºéƒ¨ç½²å¤‡ä»½..."
                            docker-compose ps > deployment_backup_\$(date +%Y%m%d_%H%M%S).log 2>/dev/null || echo "æ— ç°æœ‰æœåŠ¡éœ€è¦å¤‡ä»½"
                            
                            # æ¸…ç†å¯èƒ½æŸåçš„å®¹å™¨å’Œç½‘ç»œ
                            echo "æ¸…ç†å¯èƒ½æŸåçš„èµ„æº..."
                            docker container prune -f || true
                            docker network prune -f || true
                            
                            # æ‹‰å–æœ€æ–°é•œåƒ
                            echo "æ‹‰å–æœ€æ–°é•œåƒ..."
                            docker pull ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${DOCKER_IMAGE}-frontend:latest || exit 1
                            docker pull ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${DOCKER_IMAGE}-backend:latest || exit 1
                            
                            # æ ¹æ®éƒ¨ç½²ç­–ç•¥æ‰§è¡Œéƒ¨ç½²
                            if [ "${deployStrategy}" = "recreate" ]; then
                                echo "æ‰§è¡Œé‡å»ºéƒ¨ç½²..."
                                docker-compose down --remove-orphans || true
                                sleep 5
                                docker-compose up -d --remove-orphans
                            else
                                echo "æ‰§è¡Œæ»šåŠ¨éƒ¨ç½²..."
                                # å…ˆåœæ­¢å¯èƒ½æœ‰é—®é¢˜çš„æœåŠ¡
                                docker-compose stop backend frontend || true
                                sleep 5
                                
                                # å¯åŠ¨MySQLï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
                                docker-compose up -d mysql
                                sleep 20
                                
                                # å¯åŠ¨åç«¯
                                docker-compose up -d backend
                                sleep 15
                                
                                # å¯åŠ¨å‰ç«¯
                                docker-compose up -d frontend
                                sleep 10
                            fi
                            
                            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
                            echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
                            docker-compose ps
                            
                            # æ¸…ç†æ—§é•œåƒ
                            docker image prune -f || true
                            
                            echo "éƒ¨ç½²å®Œæˆï¼Œç­‰å¾…æœåŠ¡å¯åŠ¨..."
                            sleep 30
                        '
                    """
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                echo 'ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥...'
                script {
                    def maxRetries = 5
                    def retryCount = 0
                    def healthCheckPassed = false
                    
                    while (retryCount < maxRetries && !healthCheckPassed) {
                        try {
                            sh """
                                echo "å¥åº·æ£€æŸ¥å°è¯• \$((${retryCount} + 1))/${maxRetries}..."
                                curl -f ${HEALTH_CHECK_URL} --max-time 10
                            """
                            healthCheckPassed = true
                            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                        } catch (Exception e) {
                            retryCount++
                            if (retryCount < maxRetries) {
                                echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œ30ç§’åé‡è¯•..."
                                sleep(30)
                            } else {
                                error("âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œéƒ¨ç½²å¯èƒ½å­˜åœ¨é—®é¢˜ï¼")
                            }
                        }
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                echo 'âœ… éªŒè¯éƒ¨ç½²ç»“æœ...'
                script {
                    sh """
                        echo "éªŒè¯APIç«¯ç‚¹..."
                        curl -f ${HEALTH_CHECK_URL} || exit 1
                        curl -f http://${ALIYUN_SERVER}:3000/api/peach-varieties | head -100 || exit 1
                        echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸï¼"
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo 'ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´...'
            cleanWs()
        }
        success {
            echo 'ğŸ‰ æ„å»ºéƒ¨ç½²æˆåŠŸï¼'
            script {
                def deployInfo = """
                ğŸ“¦ Product-Catalog éƒ¨ç½²æˆåŠŸï¼
                
                ğŸ”— è®¿é—®åœ°å€: http://${ALIYUN_SERVER}:3000
                    ğŸ¥ å¥åº·æ£€æŸ¥: ${HEALTH_CHECK_URL}
                ğŸ³ é•œåƒç‰ˆæœ¬: ${FULL_DOCKER_TAG}
                ğŸ“… éƒ¨ç½²æ—¶é—´: ${new Date()}
                ğŸŒ¿ Gitåˆ†æ”¯: ${env.GIT_BRANCH}
                ğŸ“ æäº¤ID: ${GIT_COMMIT_SHORT}
                """
                echo deployInfo
            }
        }
        failure {
            echo 'âŒ æ„å»ºéƒ¨ç½²å¤±è´¥ï¼'
            script {
                def failureInfo = """
                âŒ Product-Catalog éƒ¨ç½²å¤±è´¥ï¼
                
                ğŸ“… å¤±è´¥æ—¶é—´: ${new Date()}
                ğŸŒ¿ Gitåˆ†æ”¯: ${env.GIT_BRANCH}
                ğŸ“ æäº¤ID: ${GIT_COMMIT_SHORT}
                ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯
                """
                echo failureInfo
            }
        }
        unstable {
            echo 'âš ï¸ æ„å»ºä¸ç¨³å®šï¼'
        }
    }
}