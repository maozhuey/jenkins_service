# 架构信息更新记录

## 2025-01-26 生产环境架构更新

### 服务器信息
- **阿里云ECS IP**: 60.205.0.185 (已确认为正确地址)
- **SSH认证方式**: 密码认证 (用户名: root, 密码: han0419/)
- **操作系统**: Linux (阿里云ECS)

### 容器架构
#### 运行中的容器
1. **tbk-production** (应用容器)
   - 镜像: `crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com/hanchanglin/tbk:latest`
   - 端口映射: `3001:3000` (避免端口冲突)
   - 网络: `tbk_tbk-production-network`
   - 状态: healthy
   - 访问地址: http://60.205.0.185:3001

2. **docker-mysql** (数据库容器)
   - 端口: 3306
   - 数据库: peach_wiki
   - 用户: root
   - 密码: han0419/

3. **redis-manual** (缓存容器)
   - 状态: 运行中

### 网络配置
- **主网络**: `tbk_tbk-production-network`
- **其他网络**: `tbk-manual-net`, `bridge`, `host`, `none`

### 部署目录结构
```
/opt/apps/tbk/
├── aliyun-ecs-deploy.yml      # 生产环境docker-compose文件
├── .env.production            # 生产环境配置文件 (已修复)
├── docker-compose.yml         # 本地环境配置文件
├── Dockerfile
├── package.json
├── package-lock.json
└── src/
```

### 配置文件状态
#### .env.production (已修复)
```bash
NODE_ENV=production
PORT=3000
DB_HOST=docker-mysql          # 已修复: 从localhost改为docker-mysql
DB_PORT=3306
DB_USER=root
DB_PASSWORD=han0419/          # 已修复: 从占位符改为实际密码
DB_NAME=peach_wiki
DOCKER_IMAGE_TAG=latest
API_BASE_URL=http://localhost:3000
JWT_SECRET=your_jwt_secret_here
REDIS_HOST=redis-manual
REDIS_PORT=6379
LOG_LEVEL=info
```

### 健康检查状态
- **应用健康检查**: ✅ http://60.205.0.185:3001/health 返回 "OK"
- **API接口测试**: ✅ 返回完整健康状态JSON
- **数据库连接**: ✅ 成功连接到docker-mysql
- **容器状态**: ✅ healthy

### Jenkins配置
- **Jenkins URL**: http://localhost:8082
- **项目名称**: tbk-pipeline
- **构建状态**: 构建成功，部署手动修复
- **镜像仓库**: 阿里云ACR (crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com)

### 已解决的问题
1. ✅ SSH连接配置 (IP地址和认证方式)
2. ✅ 生产环境数据库配置
3. ✅ 端口冲突问题
4. ✅ 容器启动失败
5. ✅ 应用健康检查

### 待优化项目
1. 🔄 更新Jenkins pipeline中的ECS_HOST环境变量
2. 🔄 修复docker-compose.yml语法错误
3. 🔄 配置nginx反向代理 (80端口 → 3001端口)
4. 🔄 建立自动化健康检查机制
5. 🔄 优化部署流程自动化

### 访问信息
- **应用访问**: http://60.205.0.185:3001
- **健康检查**: http://60.205.0.185:3001/health
- **数据库**: 60.205.0.185:3306 (docker-mysql容器)
- **Redis**: 60.205.0.185:6379 (redis-manual容器)

---
**更新时间**: 2025-01-26 17:04:20  
**更新人员**: AI助手  
**更新原因**: 修复Jenkins部署失败问题后的架构状态记录