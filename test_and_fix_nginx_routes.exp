#!/usr/bin/expect -f

set timeout 60

spawn ssh root@60.205.0.185
expect "password:"
send "han0419/\r"
expect "# "

send "export PAGER=cat\r"
expect "# "

# 测试tbk-app的健康检查端点
send "echo '=== 测试tbk-app的健康检查端点 ==='\r"
expect "# "
send "curl -s http://localhost:8081/health\r"
expect "# "

# 测试tbk-app的根路径
send "echo '=== 测试tbk-app的根路径 ==='\r"
expect "# "
send "curl -s http://localhost:8081/\r"
expect "# "

# 测试nginx通过代理访问tbk-app的健康检查
send "echo '=== 测试nginx代理到tbk-app的健康检查 ==='\r"
expect "# "
send "docker exec nginx-production curl -s http://tbk-app:8080/health\r"
expect "# "

# 测试nginx通过代理访问tbk-app的根路径
send "echo '=== 测试nginx代理到tbk-app的根路径 ==='\r"
expect "# "
send "docker exec nginx-production curl -s http://tbk-app:8080/\r"
expect "# "

# 检查当前nginx配置文件
send "echo '=== 检查当前nginx配置文件 ==='\r"
expect "# "
send "cat /opt/apps/tbk/nginx/production.conf\r"
expect "# "

# 测试nginx的API路由
send "echo '=== 测试nginx的API路由 ==='\r"
expect "# "
send "curl -s http://localhost:80/api/health || echo 'API route failed'\r"
expect "# "

# 检查nginx容器的健康状态
send "echo '=== 检查nginx容器的健康状态 ==='\r"
expect "# "
send "docker ps | grep nginx-production\r"
expect "# "

send "exit\r"
expect eof