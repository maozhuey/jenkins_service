pipeline {
    agent any
    
    parameters {
        stringParam(
            name: 'PROJECT',
            defaultValue: 'tbk',
            description: 'é¡¹ç›®æ ‡è¯†ï¼ˆproductç›®å½•ä¸‹çš„é¡¹ç›®åç§°ï¼‰'
        )
        booleanParam(
            name: 'CONFIRM_PRODUCTION_DEPLOY',
            defaultValue: false,
            description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ (è°¨æ…æ“ä½œ)'
        )
        booleanParam(
            name: 'AUTO_DEPLOY_ENABLED',
            defaultValue: true,
            description: 'å¯ç”¨è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
        )
        choice(
            name: 'DEPLOY_STRATEGY',
            choices: ['rolling', 'recreate', 'blue-green'],
            description: 'éƒ¨ç½²ç­–ç•¥'
        )
        stringParam(
            name: 'BRANCH_INFO',
            defaultValue: 'main (ç”Ÿäº§ç¯å¢ƒ)',
            description: 'æ„å»ºåˆ†æ”¯ä¿¡æ¯'
        )
    }
    
    environment {
        // Aliyun ACR Configuration
        DOCKER_REGISTRY = 'crpi-p6joc7xl4atpiic8.cn-hangzhou.personal.cr.aliyuncs.com'
        DOCKER_NAMESPACE = 'hanchanglin'
        DOCKER_CREDENTIALS = 'aliyun-acr'
        
        // Application Configuration
        APP_NAME = "${params.PROJECT}"
        NODE_VERSION = '18'
        
        // Build Configuration
        BUILD_NUMBER = "${env.BUILD_NUMBER}"
        GIT_COMMIT_SHORT = "${env.GIT_COMMIT?.take(7) ?: 'unknown'}"
        DOCKER_TAG = "${BUILD_NUMBER}-${GIT_COMMIT_SHORT}"
        
        // Product Architecture Paths
        PRODUCT_DIR = 'product'
        PROJECT_DIR = "${PRODUCT_DIR}/${params.PROJECT}"
        SHARED_DIR = "${PRODUCT_DIR}/shared"
        
        // Security Configuration
        PRODUCTION_SERVER = 'localhost'
        HEALTH_CHECK_URL = "http://localhost:8081/health"
    }
    
    stages {
        stage('ç¯å¢ƒæ£€æŸ¥') {
            steps {
                script {
                    echo "ğŸ” æ£€æŸ¥æ„å»ºç¯å¢ƒ..."
                    echo "é¡¹ç›®: ${params.PROJECT}"
                    echo "åˆ†æ”¯: ${params.BRANCH_INFO}"
                    echo "æ„å»ºå·: ${BUILD_NUMBER}"
                    echo "Gitæäº¤: ${GIT_COMMIT_SHORT}"
                    echo "é¡¹ç›®ç›®å½•: ${PROJECT_DIR}"
                    
                    // æ£€æŸ¥é¡¹ç›®ç›®å½•æ˜¯å¦å­˜åœ¨
                    if (!fileExists("${PROJECT_DIR}")) {
                        error("âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨: ${PROJECT_DIR}")
                    }
                    
                    // æ£€æŸ¥docker-composeæ–‡ä»¶
                    if (!fileExists("${PROJECT_DIR}/docker-compose.yml")) {
                        error("âŒ docker-compose.ymlæ–‡ä»¶ä¸å­˜åœ¨: ${PROJECT_DIR}/docker-compose.yml")
                    }
                    
                    echo "âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
                }
            }
        }
        
        stage('ä»£ç æ£€å‡º') {
            steps {
                script {
                    echo "ğŸ“¥ æ£€å‡ºä»£ç ..."
                    checkout scm
                    
                    // éªŒè¯é¡¹ç›®ç»“æ„
                    sh """
                        echo "éªŒè¯productç›®å½•ç»“æ„..."
                        ls -la ${PRODUCT_DIR}/
                        echo "éªŒè¯é¡¹ç›®ç›®å½•..."
                        ls -la ${PROJECT_DIR}/
                        echo "éªŒè¯å…±äº«èµ„æºç›®å½•..."
                        ls -la ${SHARED_DIR}/
                    """
                }
            }
        }
        
        stage('ä¾èµ–å®‰è£…') {
            steps {
                script {
                    echo "ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–..."
                    dir("${PROJECT_DIR}") {
                        sh """
                            echo "å½“å‰ç›®å½•: \$(pwd)"
                            if [ -f package.json ]; then
                                echo "å®‰è£…Node.jsä¾èµ–..."
                                npm ci --production=false
                            else
                                echo "âš ï¸ æœªæ‰¾åˆ°package.jsonæ–‡ä»¶"
                            fi
                        """
                    }
                }
            }
        }
        
        stage('ä»£ç æµ‹è¯•') {
            steps {
                script {
                    echo "ğŸ§ª è¿è¡Œä»£ç æµ‹è¯•..."
                    dir("${PROJECT_DIR}") {
                        sh """
                            if [ -f package.json ] && npm run | grep -q "test"; then
                                echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
                                npm test
                            else
                                echo "âš ï¸ æœªé…ç½®æµ‹è¯•è„šæœ¬ï¼Œè·³è¿‡æµ‹è¯•é˜¶æ®µ"
                            fi
                        """
                    }
                }
            }
        }
        
        stage('æ„å»ºDockeré•œåƒ') {
            steps {
                script {
                    echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
                    dir("${PROJECT_DIR}") {
                        sh """
                            echo "æ„å»ºé•œåƒ: ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${APP_NAME}:${DOCKER_TAG}"
                            docker build -t ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${APP_NAME}:${DOCKER_TAG} .
                            docker tag ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${APP_NAME}:${DOCKER_TAG} ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${APP_NAME}:latest
                        """
                    }
                }
            }
        }
        
        stage('æ¨é€é•œåƒ') {
            steps {
                script {
                    echo "ğŸ“¤ æ¨é€Dockeré•œåƒåˆ°é˜¿é‡Œäº‘ACR..."
                    withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS}", usernameVariable: 'DOCKER_USERNAME', passwordVariable: 'DOCKER_PASSWORD')]) {
                        sh """
                            echo "ç™»å½•é˜¿é‡Œäº‘ACR..."
                            echo \$DOCKER_PASSWORD | docker login --username \$DOCKER_USERNAME --password-stdin ${DOCKER_REGISTRY}
                            
                            echo "æ¨é€é•œåƒ..."
                            docker push ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${APP_NAME}:${DOCKER_TAG}
                            docker push ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/${APP_NAME}:latest
                        """
                    }
                }
            }
        }
        
        stage('éƒ¨ç½²ç¡®è®¤') {
            when {
                expression { params.CONFIRM_PRODUCTION_DEPLOY == true }
            }
            steps {
                script {
                    echo "âš ï¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç¡®è®¤..."
                    timeout(time: 5, unit: 'MINUTES') {
                        input message: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ', ok: 'ç¡®è®¤éƒ¨ç½²',
                              submitterParameter: 'DEPLOYER'
                    }
                    echo "âœ… éƒ¨ç½²å·²ç¡®è®¤ï¼Œæ‰§è¡Œäºº: ${env.DEPLOYER}"
                }
            }
        }
        
        stage('éƒ¨ç½²åº”ç”¨') {
            steps {
                script {
                    echo "ğŸš€ éƒ¨ç½²åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ..."
                    dir("${PROJECT_DIR}") {
                        sh """
                            echo "åœæ­¢ç°æœ‰å®¹å™¨..."
                            docker-compose down || true
                            
                            echo "æ¸…ç†æ—§é•œåƒ..."
                            docker image prune -f || true
                            
                            echo "å¯åŠ¨æ–°ç‰ˆæœ¬..."
                            export DOCKER_TAG=${DOCKER_TAG}
                            docker-compose up -d
                            
                            echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
                            sleep 30
                        """
                    }
                }
            }
        }
        
        stage('å¥åº·æ£€æŸ¥') {
            steps {
                script {
                    echo "ğŸ¥ æ‰§è¡Œåº”ç”¨å¥åº·æ£€æŸ¥..."
                    retry(3) {
                        sh """
                            echo "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
                            curl -f ${HEALTH_CHECK_URL} || exit 1
                            echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
                        """
                    }
                }
            }
        }
        
        stage('æ¸…ç†èµ„æº') {
            steps {
                script {
                    echo "ğŸ§¹ æ¸…ç†æ„å»ºèµ„æº..."
                    sh """
                        echo "æ¸…ç†Dockeræ„å»ºç¼“å­˜..."
                        docker system prune -f --volumes || true
                        
                        echo "æ¸…ç†æ—§é•œåƒ..."
                        docker images | grep ${APP_NAME} | grep -v latest | grep -v ${DOCKER_TAG} | awk '{print \$3}' | xargs -r docker rmi || true
                    """
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo "ğŸ“Š æ„å»ºå®Œæˆï¼Œæ¸…ç†å·¥ä½œç©ºé—´..."
                cleanWs()
            }
        }
        success {
            script {
                echo "âœ… æ„å»ºæˆåŠŸï¼"
                echo "é¡¹ç›®: ${params.PROJECT}"
                echo "ç‰ˆæœ¬: ${DOCKER_TAG}"
                echo "éƒ¨ç½²ç­–ç•¥: ${params.DEPLOY_STRATEGY}"
            }
        }
        failure {
            script {
                echo "âŒ æ„å»ºå¤±è´¥ï¼"
                echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
            }
        }
    }
}
