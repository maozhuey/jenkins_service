#!/usr/bin/expect -f

# æœ€ç»ˆè¿æ¥æµ‹è¯• - éªŒè¯ç«¯å£3306

set timeout 30
set server_ip "60.205.0.185"
set server_user "root"
set server_password "han0419/"

# è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨
spawn sshpass -p $server_password ssh -o StrictHostKeyChecking=no $server_user@$server_ip

expect {
    "*]#" {
        send_user "\n=== å·²è¿æ¥åˆ°è¿œç¨‹æœåŠ¡å™¨ ===\n"
    }
    timeout {
        send_user "\nè¿æ¥æœåŠ¡å™¨è¶…æ—¶\n"
        exit 1
    }
}

# è¿›å…¥tbkç›®å½•
send "cd /root/tbk\r"
expect "*]#"

send_user "\n=== æœ€ç»ˆè¿æ¥æµ‹è¯• ===\n"

# 1. æ£€æŸ¥å®¹å™¨çŠ¶æ€
send_user "\n--- å®¹å™¨çŠ¶æ€ ---\n"
send "docker ps | grep tbk-mysql\r"
expect "*]#"

# 2. æ£€æŸ¥ç«¯å£ç›‘å¬
send_user "\n--- ç«¯å£ç›‘å¬çŠ¶æ€ ---\n"
send "netstat -tlnp | grep 3306\r"
expect "*]#"

# 3. æµ‹è¯•rootç”¨æˆ·è¿æ¥
send_user "\n--- æµ‹è¯•rootç”¨æˆ·è¿æ¥ ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -e \"SELECT 'Root connection successful on port 3306' as status;\"\r"
expect "*]#"

# 4. æµ‹è¯•tbk_adminç”¨æˆ·è¿æ¥
send_user "\n--- æµ‹è¯•tbk_adminç”¨æˆ·è¿æ¥ ---\n"
send "docker exec tbk-mysql mysql -u tbk_admin -pHan0419@MySQL -D tbk -e \"SELECT 'tbk_admin connection successful' as status;\"\r"
expect "*]#"

# 5. æŸ¥çœ‹æ•°æ®åº“åˆ—è¡¨
send_user "\n--- æ•°æ®åº“åˆ—è¡¨ ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -e \"SHOW DATABASES;\"\r"
expect "*]#"

# 6. æŸ¥çœ‹tbkæ•°æ®åº“ä¸­çš„è¡¨
send_user "\n--- tbkæ•°æ®åº“è¡¨åˆ—è¡¨ ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -D tbk -e \"SHOW TABLES;\"\r"
expect "*]#"

# 7. æŸ¥çœ‹æµ‹è¯•æ•°æ®
send_user "\n--- æµ‹è¯•æ•°æ® ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -D tbk -e \"SELECT * FROM categories LIMIT 3;\"\r"
expect "*]#"

send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -D tbk -e \"SELECT * FROM articles LIMIT 3;\"\r"
expect "*]#"

send_user "\n=== è¿æ¥æµ‹è¯•å®Œæˆ ===\n"
send_user "âœ… tbk-mysqlå®¹å™¨å·²æˆåŠŸè¿è¡Œåœ¨ç«¯å£3306\n"
send_user "âœ… æ•°æ®åº“å’Œè¡¨ç»“æ„å®Œæ•´\n"
send_user "âœ… æµ‹è¯•æ•°æ®æ­£å¸¸\n"
send_user "\nğŸ“‹ è¿æ¥ä¿¡æ¯:\n"
send_user "   ä¸»æœº: 60.205.0.185\n"
send_user "   ç«¯å£: 3306\n"
send_user "   æ•°æ®åº“: tbk\n"
send_user "   ç”¨æˆ·: root æˆ– tbk_admin\n"
send_user "   å¯†ç : Han0419@MySQL\n"

# é€€å‡º
send "exit\r"
expect eof