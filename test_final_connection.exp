#!/usr/bin/expect -f

# 最终连接测试 - 验证端口3306

set timeout 30
set server_ip "60.205.0.185"
set server_user "root"
set server_password "han0419/"

# 连接到远程服务器
spawn sshpass -p $server_password ssh -o StrictHostKeyChecking=no $server_user@$server_ip

expect {
    "*]#" {
        send_user "\n=== 已连接到远程服务器 ===\n"
    }
    timeout {
        send_user "\n连接服务器超时\n"
        exit 1
    }
}

# 进入tbk目录
send "cd /root/tbk\r"
expect "*]#"

send_user "\n=== 最终连接测试 ===\n"

# 1. 检查容器状态
send_user "\n--- 容器状态 ---\n"
send "docker ps | grep tbk-mysql\r"
expect "*]#"

# 2. 检查端口监听
send_user "\n--- 端口监听状态 ---\n"
send "netstat -tlnp | grep 3306\r"
expect "*]#"

# 3. 测试root用户连接
send_user "\n--- 测试root用户连接 ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -e \"SELECT 'Root connection successful on port 3306' as status;\"\r"
expect "*]#"

# 4. 测试tbk_admin用户连接
send_user "\n--- 测试tbk_admin用户连接 ---\n"
send "docker exec tbk-mysql mysql -u tbk_admin -pHan0419@MySQL -D tbk -e \"SELECT 'tbk_admin connection successful' as status;\"\r"
expect "*]#"

# 5. 查看数据库列表
send_user "\n--- 数据库列表 ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -e \"SHOW DATABASES;\"\r"
expect "*]#"

# 6. 查看tbk数据库中的表
send_user "\n--- tbk数据库表列表 ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -D tbk -e \"SHOW TABLES;\"\r"
expect "*]#"

# 7. 查看测试数据
send_user "\n--- 测试数据 ---\n"
send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -D tbk -e \"SELECT * FROM categories LIMIT 3;\"\r"
expect "*]#"

send "docker exec tbk-mysql mysql -u root -pHan0419@MySQL -D tbk -e \"SELECT * FROM articles LIMIT 3;\"\r"
expect "*]#"

send_user "\n=== 连接测试完成 ===\n"
send_user "✅ tbk-mysql容器已成功运行在端口3306\n"
send_user "✅ 数据库和表结构完整\n"
send_user "✅ 测试数据正常\n"
send_user "\n📋 连接信息:\n"
send_user "   主机: 60.205.0.185\n"
send_user "   端口: 3306\n"
send_user "   数据库: tbk\n"
send_user "   用户: root 或 tbk_admin\n"
send_user "   密码: Han0419@MySQL\n"

# 退出
send "exit\r"
expect eof