#!/usr/bin/expect -f

set timeout 60

spawn ssh root@60.205.0.185
expect "password:"
send "han0419/\r"
expect "# "

send "export PAGER=cat\r"
expect "# "

# 测试所有基础端点
send "echo '=== 测试所有基础端点 ==='\r"
expect "# "
send "curl -s -w '\\nStatus: %{http_code}\\n' http://localhost:80/\r"
expect "# "
send "curl -s -w '\\nStatus: %{http_code}\\n' http://localhost:80/health\r"
expect "# "
send "curl -s -w '\\nStatus: %{http_code}\\n' http://localhost:80/api/health\r"
expect "# "
send "curl -s -w '\\nStatus: %{http_code}\\n' http://localhost:80/db-test\r"
expect "# "

# 测试分类端点
send "echo '=== 测试分类端点 ==='\r"
expect "# "
send "curl -s -w '\\nStatus: %{http_code}\\n' http://localhost:80/categories\r"
expect "# "

# 测试文章端点
send "echo '=== 测试文章端点 ==='\r"
expect "# "
send "curl -s -w '\\nStatus: %{http_code}\\n' http://localhost:80/articles\r"
expect "# "

# 检查所有容器状态
send "echo '=== 检查所有容器状态 ==='\r"
expect "# "
send "docker ps --format 'table {{.Names}}\\t{{.Status}}\\t{{.Ports}}'\r"
expect "# "

# 检查网络连接
send "echo '=== 检查网络连接 ==='\r"
expect "# "
send "docker network ls\r"
expect "# "
send "docker network inspect tbk_tbk-network | grep -A 5 -B 5 'Containers'\r"
expect "# "

# 检查数据库连接
send "echo '=== 检查数据库连接 ==='\r"
expect "# "
send "docker exec tbk-app node -e \"const mysql = require('mysql2'); const connection = mysql.createConnection({host: 'docker-mysql', user: 'peach_wiki', password: 'han0419/', database: 'peach_wiki'}); connection.connect((err) => { if (err) { console.log('连接失败:', err.message); } else { console.log('数据库连接成功!'); connection.end(); } });\"\r"
expect "# "

# 检查数据库中的数据
send "echo '=== 检查数据库中的数据 ==='\r"
expect "# "
send "docker exec docker-mysql mysql -u peach_wiki -phan0419/ peach_wiki -e \"SHOW TABLES;\"\r"
expect "# "
send "docker exec docker-mysql mysql -u peach_wiki -phan0419/ peach_wiki -e \"SELECT COUNT(*) as category_count FROM categories;\"\r"
expect "# "
send "docker exec docker-mysql mysql -u peach_wiki -phan0419/ peach_wiki -e \"SELECT COUNT(*) as article_count FROM articles;\"\r"
expect "# "

# 测试nginx日志
send "echo '=== 检查nginx访问日志 ==='\r"
expect "# "
send "docker logs --tail 20 nginx-production\r"
expect "# "

# 测试应用日志
send "echo '=== 检查应用日志 ==='\r"
expect "# "
send "docker logs --tail 20 tbk-app\r"
expect "# "

send "exit\r"
expect eof